<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Fighting Spam on the Cheap with CAPTCHA - A Simple Ruby Library for captchas.net | Depth-First</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="A recent article discussed two free services for cheaply integrating CAPTCHAs into Web applications. One of these services, captchas.net, apparently has no publicly-available Ruby library. Given the popularity of Ruby on Rails for building Web applications, and the increasing need for spam protection offered by services such as captchas.net, it seems only logical that such a library should exist. This article, the first in a series, documents the first step in the development of a simple Rails library for working with captchas.net.">
    <meta name="generator" content="Hugo 0.139.4">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    
      <meta name="author" content = "Richard L. Apodaca">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="https://depth-first.com:1313/articles/2007-09-03-fighting-spam-on-the-cheap-with-captcha-a-simple-ruby-library-for-captchas-net/">
    

    <meta property="og:url" content="https://depth-first.com:1313/articles/2007-09-03-fighting-spam-on-the-cheap-with-captcha-a-simple-ruby-library-for-captchas-net/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="Fighting Spam on the Cheap with CAPTCHA - A Simple Ruby Library for captchas.net">
  <meta property="og:description" content="A recent article discussed two free services for cheaply integrating CAPTCHAs into Web applications. One of these services, captchas.net, apparently has no publicly-available Ruby library. Given the popularity of Ruby on Rails for building Web applications, and the increasing need for spam protection offered by services such as captchas.net, it seems only logical that such a library should exist. This article, the first in a series, documents the first step in the development of a simple Rails library for working with captchas.net.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="articles">
    <meta property="article:published_time" content="2007-09-03T00:00:00+00:00">
    <meta property="article:modified_time" content="2007-09-03T00:00:00+00:00">

  <meta itemprop="name" content="Fighting Spam on the Cheap with CAPTCHA - A Simple Ruby Library for captchas.net">
  <meta itemprop="description" content="A recent article discussed two free services for cheaply integrating CAPTCHAs into Web applications. One of these services, captchas.net, apparently has no publicly-available Ruby library. Given the popularity of Ruby on Rails for building Web applications, and the increasing need for spam protection offered by services such as captchas.net, it seems only logical that such a library should exist. This article, the first in a series, documents the first step in the development of a simple Rails library for working with captchas.net.">
  <meta itemprop="datePublished" content="2007-09-03T00:00:00+00:00">
  <meta itemprop="dateModified" content="2007-09-03T00:00:00+00:00">
  <meta itemprop="wordCount" content="549">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Fighting Spam on the Cheap with CAPTCHA - A Simple Ruby Library for captchas.net">
  <meta name="twitter:description" content="A recent article discussed two free services for cheaply integrating CAPTCHAs into Web applications. One of these services, captchas.net, apparently has no publicly-available Ruby library. Given the popularity of Ruby on Rails for building Web applications, and the increasing need for spam protection offered by services such as captchas.net, it seems only logical that such a library should exist. This article, the first in a series, documents the first step in the development of a simple Rails library for working with captchas.net.">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Depth-First
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Articles
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Fighting Spam on the Cheap with CAPTCHA - A Simple Ruby Library for captchas.net</h1>
      
      <p class="tracked">
        By <strong>Richard L. Apodaca</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2007-09-03T00:00:00Z">September 3, 2007</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>A <a href="/articles/2007/09/01/fighting-comment-spam-on-the-cheap-with-captcha">recent article</a> discussed two free services for cheaply integrating <a href="http://en.wikipedia.org/wiki/Captcha">CAPTCHAs</a> into Web applications. One of these services, <a href="http://captchas.net">captchas.net</a>, apparently has no publicly-available Ruby library. Given the popularity of <a href="http://rubyonrails.com">Ruby on Rails</a> for building Web applications, and the increasing need for spam protection offered by services such as <a href="http://captchas.net">captchas.net</a>, it seems only logical that such a library should exist. This article, the first in a series, documents the first step in the development of a simple Rails library for working with captchas.net.</p>
<h1 id="got-key">Got Key?</h1>
<p>To use captchas.net, you&rsquo;ll need to <a href="http://captchas.net/registration/">register for an account</a>. You&rsquo;ll receive a secret key used in decoding the text represented in the CAPTCHA, and a username that will be encoded with your capthcas.net URLs.</p>
<h1 id="building-a-url">Building a URL</h1>
<p>To get your CAPTCHA image from captchas.net, construct a URL containing the appropriate parameters. The simplest form of a captchas.net URL accepts your user name (&lsquo;demo&rsquo;) and a random phrase (&lsquo;my_random_text&rsquo;), and returns a complete CAPTCHA image. Customization is possible, but we&rsquo;ll just stick with the simple case for now. As an example, this URL:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://image.captchas.net/?client<span style="color:#f92672">=</span>demo&amp;random<span style="color:#f92672">=</span>my_random_text
</span></span></code></pre></div><p>generates this image:</p>
<p><img src="http://image.captchas.net/?client=demo&amp;random=my_random_text" alt="Captcha" title="Captcha"></p>
<p>The URL above is all you need to embed a CAPTCHA into your webpage. The random text we&rsquo;ve encoded in the URL (&lsquo;my_random_text&rsquo;) is processed by the captchas.net server to create the six-character sequence shown in the image. Read on to find out how.</p>
<h1 id="decoding-the-captcha">Decoding the CAPTCHA</h1>
<p>We&rsquo;ve got a CAPTCHA, but how do we know what&rsquo;s written in it? This is where our secret key comes in. Here&rsquo;s the method used by the captchas.net server to generate the image text:</p>
<ul>
<li>concatenate the secret key and the random string (example: &lsquo;secret&rsquo; and &lsquo;my_random_text&rsquo; become &lsquo;secretmy_random_text&rsquo;)</li>
<li>if <!-- raw HTML omitted -->alphabet<!-- raw HTML omitted --> or <!-- raw HTML omitted -->character_count<!-- raw HTML omitted --> differs from &lsquo;abcdefghijklmnopqrstuvwxyz&rsquo; and 6, respectively, append both separated by &lsquo;:&rsquo; (&lt;secret&gt;&lt;random&gt;:&lt;<!-- raw HTML omitted -->alphabet<!-- raw HTML omitted -->&gt;:&lt;<!-- raw HTML omitted -->character_count<!-- raw HTML omitted -->&gt;).</li>
<li>take the MD5-sum of the resulting string</li>
<li>take the first <!-- raw HTML omitted -->character_count<!-- raw HTML omitted --> bytes of the resulting 16-byte-long MD5 value</li>
<li>determine the remainders of this <!-- raw HTML omitted -->character_count<!-- raw HTML omitted --> bytes, when dividing by the length of <!-- raw HTML omitted -->alphabet<!-- raw HTML omitted --></li>
<li>every number encodes a character from the chosen <!-- raw HTML omitted -->alphabet<!-- raw HTML omitted --> (example: &ldquo;hnrppb&rdquo;)</li>
</ul>
<p>The <a href="http://catpchas.net">captchas.net site</a> has a more complete description of the algorithm and an interactive CAPTCHA generator that is very helpful in understanding how CAPTCHAs are generated.</p>
<h1 id="a-simple-library">A Simple Library</h1>
<p>Given the algorithm, a short Ruby library can be written to find the text encoded in a captchas.net CAPTCHA:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;digest/md5&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Captcha
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_text</span> secret, random, alphabet<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span>, character_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> character_count <span style="color:#f92672">&amp;</span>lt; <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> character_count <span style="color:#f92672">&amp;</span>gt; <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">raise</span> <span style="color:#e6db74">&#34;Character count of </span><span style="color:#e6db74">#{</span>character_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> is outside the range of 1-16&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    input <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#{</span>secret<span style="color:#e6db74">}#{</span>random<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> alphabet <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span> <span style="color:#f92672">||</span> character_count <span style="color:#f92672">!=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>      input <span style="color:#f92672">&amp;</span>lt;<span style="color:#f92672">&amp;</span>lt;  <span style="color:#e6db74">&#34;:</span><span style="color:#e6db74">#{</span>alphabet<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">#{</span>character_count<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bytes <span style="color:#f92672">=</span> <span style="color:#66d9ef">Digest</span><span style="color:#f92672">::</span><span style="color:#66d9ef">MD5</span><span style="color:#f92672">.</span>hexdigest(input)<span style="color:#f92672">.</span>slice(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>character_count <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>scan(<span style="color:#e6db74">/../</span>)
</span></span><span style="display:flex;"><span>    text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bytes<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>byte<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      text <span style="color:#f92672">&amp;</span>lt;<span style="color:#f92672">&amp;</span>lt; alphabet<span style="color:#f92672">[</span>byte<span style="color:#f92672">.</span>hex <span style="color:#f92672">%</span> alphabet<span style="color:#f92672">.</span>size<span style="color:#f92672">].</span>chr
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    text
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span> 
</span></span></code></pre></div><p>We can test the library using irb:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>irb
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:001:0&gt; require <span style="color:#e6db74">&#39;captcha&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; true
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:002:0&gt; include Captcha
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; Object
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:003:0&gt; get_text <span style="color:#e6db74">&#39;secret&#39;</span>, <span style="color:#e6db74">&#39;my_random_text&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;hnrppb&#34;</span>
</span></span></code></pre></div><p>If we wanted to include numerical digits and require additional characters, the library enables this as well:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>irb
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:001:0&gt; require <span style="color:#e6db74">&#39;captcha&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; true
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:002:0&gt; include Captcha
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; Object
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:003:0&gt; get_text <span style="color:#e6db74">&#39;secret&#39;</span>, <span style="color:#e6db74">&#39;my_random_text&#39;</span>, <span style="color:#e6db74">&#39;abcdefghijklmnopqrstuvwxyz0123456789&#39;</span>, 7
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;62m3acs&#34;</span>
</span></span></code></pre></div><h1 id="conclusions">Conclusions</h1>
<p>That&rsquo;s really all there is to the Ruby library. Once we can create a CAPTCHA image and decode its contents, we can begin to think about building an integrated Rails solution. But that&rsquo;s a story for another time.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://depth-first.com:1313/" >
    &copy;  Depth-First 2024 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
