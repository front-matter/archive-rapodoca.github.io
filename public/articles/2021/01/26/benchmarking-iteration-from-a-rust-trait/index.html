<!DOCTYPE html>
<html lang="en-us" dir="ltr" class="scroll-smooth" data-default-appearance="light"
  data-auto-appearance="true"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en-us" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Benchmarking Iteration from a Rust Trait &middot; Depth-First</title>
  <meta name="title" content="Benchmarking Iteration from a Rust Trait &middot; Depth-First" />
  
  <meta name="description" content="Quantitating the relative performance of slices and boxed Iterators in graphs." />
  
  
  
  <link rel="canonical" href="http://localhost:1313/articles/2021/01/26/benchmarking-iteration-from-a-rust-trait/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.e27868ab1485f7ed7b06b122b4980bd38b19526eb8f7de885181204d28f04a0c47e9c334eff19a06c0278eb2ff8415b983a5d0fb80fd6b5680c926457cc61c57.css"
    integrity="sha512-4nhoqxSF9&#43;17BrEitJgL04sZUm64996IUYEgTSjwSgxH6cM07/GaBsAnjrL/hBW5g6XQ&#43;4D9a1aAySZFfMYcVw==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.c178288131a2f1ad46910438db47ac5f7e1c48cf949e49f6dc3310c8ec9660e23fe505805eba4e2e73711335808500360d773a2b64322feb35df52856edca286.js"
    integrity="sha512-wXgogTGi8a1GkQQ420esX34cSM&#43;Unkn23DMQyOyWYOI/5QWAXrpOLnNxEzWAhQA2DXc6K2QyL&#43;s131KFbtyihg==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="http://localhost:1313/articles/2021/01/26/benchmarking-iteration-from-a-rust-trait/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="Benchmarking Iteration from a Rust Trait">
  <meta property="og:description" content="Quantitating the relative performance of slices and boxed Iterators in graphs.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-01-26T19:00:00+00:00">
    <meta property="article:modified_time" content="2021-01-26T19:00:00+00:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Benchmarking Iteration from a Rust Trait">
  <meta name="twitter:description" content="Quantitating the relative performance of slices and boxed Iterators in graphs.">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Benchmarking Iteration from a Rust Trait",
    "headline": "Benchmarking Iteration from a Rust Trait",
    
    "abstract": "Quantitating the relative performance of slices and boxed Iterators in graphs.",
    "inLanguage": "en-us",
    "url" : "http:\/\/localhost:1313\/articles\/2021\/01\/26\/benchmarking-iteration-from-a-rust-trait\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    "copyrightYear": "2021",
    "dateCreated": "2021-01-26T19:00:00\u002b00:00",
    "datePublished": "2021-01-26T19:00:00\u002b00:00",
    
    "dateModified": "2021-01-26T19:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "2219"
  }]
  </script>


  
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Depth-First</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            

            </div>
        </label>
    </div>
</div>





  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Benchmarking Iteration from a Rust Trait
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2021-01-26T19:00:00&#43;00:00">January 26, 2021</time><span class="px-2 text-primary-500">&middot;</span><span>2219 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">11 mins</span>
  

  
  
</div>








    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
  <div class="place-self-center">
    
    
    <div class="text-2xl sm:text-lg">
</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
    

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          <p>Iterators are ubiquitous in Rust and mostly just work. Even so, Rust Iterators carry some noteworthy caveats. For an example, consider the case of returning an Iterator from a method defined on a trait. This article describes the problem and offers evidence supporting a practical and ergonomic solution.</p>


<h1 class="relative group">A Graph Trait 
    <div id="a-graph-trait" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#a-graph-trait" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Imagine designing a Rust crate for working with graphs. Here I&rsquo;m referring to the <a href="https://en.wikipedia.org/wiki/Graph_%28discrete_mathematics%29" target="_blank">mathematical construct</a>, not a <a href="https://en.wikipedia.org/wiki/Chart" target="_blank">chart</a>. The performance of many graph algorithms depends on the way graphs themselves are implemented. Two well-known extremes are <em><a href="https://en.wikipedia.org/wiki/Adjacency_list" target="_blank">adjacency lists</a></em> and <em><a href="https://en.wikipedia.org/wiki/Adjacency_matrix" target="_blank">adjacency matricies</a></em>. An adjacency matrix uses a square matrix in which off-diagonal elements represent edges. An adjacency list uses a jagged list in which each element holds an array of neighbors. The two implementation perform exactly the same task, but with different performance tradeoffs. Various optimizations within each approach are known.</p>
<p>This situation, in which the same set of methods have multiple useful implementations, suggests the use of <em><a href="https://doc.rust-lang.org/book/ch10-02-traits.html" target="_blank">trait</a></em>. A Rust trait is a collection of method signatures that can be implemented by any type — now or in the future. Other languages use different names for the same concept. Java has &ldquo;interfaces.&rdquo; C++ has &ldquo;abstract classes.&rdquo; Duck-typed languages such as Ruby or JavaScript have nothing, but that&rsquo;s another story.</p>
<p>What should a <code>Graph</code> trait look like? A <a href="/articles/2020/01/06/a-minimal-graph-api/">previous article</a> examined this question in detail. To recap, only eleven methods are required. Three of them iterate values:</p>
<ul>
<li><code>ids</code>. Iterates the node IDs for the graph. Also known as <code>nodes</code>.</li>
<li><code>neighbors</code>. Iterates the node IDs for the neighbors of a node identified by its ID</li>
<li><code>edges</code>. Iterates edges as a pair of node identifiers.</li>
</ul>
<p>The minimal graph API is straightforward to implement in other languages using readily-available primitives such as maps and arrays. In Rust, however, things aren&rsquo;t so clear-cut. Those three methods above raise some difficult issues.</p>


<h1 class="relative group">The Problem 
    <div id="the-problem" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#the-problem" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>A <a href="https://doc.rust-lang.org/book/ch13-02-iterators.html" target="_blank">Rust iterator</a> is a value that implements the <code>Iterator</code> trait and its single method <code>next</code>. Rust takes this approach for the same reason that a <code>Graph</code> trait is desirable: there are many possible implementations, but it&rsquo;s more convenient for clients to work with a single type.</p>
<p>Returning an iterator from a method is easy. Consider, for example, a struct that owns a collection of integers. The goal is to provide a method for iterating them without revealing the underlying implementation. The code below is one way to do that. For details on the anonymous lifetime near the end of the method declaration (<code>'_</code>), see <a href="https://blog.katona.me/2019/12/29/Rust-Lifetimes-and-Iterators/" target="_blank">this</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Owner</span> {
</span></span><span style="display:flex;"><span>    ids: Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Owner {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">ids</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">impl</span> Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">=</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_ {
</span></span><span style="display:flex;"><span>        self.ids.iter().cloned()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[test]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> owner <span style="color:#f92672">=</span> Owner { ids: <span style="color:#a6e22e">vec</span><span style="color:#f92672">!</span>[ <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span> ] };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    assert_eq!(owner.ids().collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>(), [ <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span> ])
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Notice that the private field <code>ids</code> could just as easily be replaced with a <code>Set</code>, a <code>HashSet</code>, or any other type that can produce an <code>Iterator</code>. In no case does a client need to know which <code>Iterator</code> implementation it receives. Moreover, the standard library makes several powerful iterator methods available for free. This is, of course, the power of Rust traits.</p>
<p>But there&rsquo;s a problem. Adding the <code>ids</code> method to a trait leads to an error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">trait</span> Owner {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ERROR💥: &#34;`impl Trait` not allowed outside of function and inherent method return types rustc(E0562)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">ids</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">impl</span> Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">=</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <a href="https://doc.rust-lang.org/error-index.html#E0562" target="_blank">documentation for error E0562</a> informs us that:</p>
<blockquote>
<p>Abstract return types (written <code>impl Trait</code> for some trait Trait) are only allowed as function and inherent impl return types.</p>
</blockquote>
<p>In other words, returning a bare trait object from a trait method is not allowed. <a href="/articles/2020/06/22/returning-rust-iterators/">A previous article</a> discussed this situation in detail. To reiterate the conclusion, the best option for returning an iterator from a trait method: a boxed trait object.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">trait</span> Owner {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// NO ERROR!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">ids</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">dyn</span> Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">=</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">MyOwner</span> {
</span></span><span style="display:flex;"><span>    ids: Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Owner <span style="color:#66d9ef">for</span> MyOwner {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">ids</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">dyn</span> Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">=</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        Box::new(self.ids.iter().cloned())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[test]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> owner <span style="color:#f92672">=</span> MyOwner { ids: <span style="color:#a6e22e">vec</span><span style="color:#f92672">!</span>[ <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span> ] };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    assert_eq!(owner.ids().collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>(), [ <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span> ])
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><a href="https://doc.rust-lang.org/std/boxed/struct.Box.html" target="_blank"><code>Box</code></a> is a heap-allocated pointer that automatically delegates the methods of the value it owns. As such, the return value can be used in exactly the same way as a concrete type. This is illustrated in the <code>test</code> function, which uses the <code>Iterator#collect</code> method as if it were defined on <code>Box</code>.</p>
<p>As discussed previously, it&rsquo;s technically possible to use associated types here as well. The <code>Owner</code> trait could, for example, be defined with an associated type <code>ItemIterator</code>. The main feature of this approach is that it does not require a <code>Box</code>. An <code>Iterator</code> can be returned directly from the <code>items</code> method by the implementor. And that could improve performance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">trait</span> Owner2 {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ItemIterator</span>: Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">=</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">items</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Self</span>::ItemIterator;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Unfortunately, all of my attempts to implement the <code>Owner2</code> trait have ultimately resulted in the introduction of a lifetime parameter. A way around this problem will have to await <a href="https://stackoverflow.com/questions/54161441/" target="_blank">generic associated types</a>. Suffice it to say that a library with a foundational type carrying a lifetime parameter (e.g., <code>Graph&lt;'a&gt;</code>) is going to be very hard to use.</p>
<p>Boxed iterators uniquely solve the problem today without introducing a lifetime parameter. But what about performance?</p>


<h1 class="relative group">Boxed Iterator Performance 
    <div id="boxed-iterator-performance" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#boxed-iterator-performance" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>To my knowledge, no 1:1 comparison of the performance of boxed iterators and an alternative has ever been published. A few hypotheses have been put forward, as can be seen in:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/28621980/" target="_blank">What are the actual runtime performance costs of dynamic dispatch?</a></li>
<li><a href="https://users.rust-lang.org/t/performance-implications-of-box-trait-vs-enum-delegation/11957" target="_blank">Performance implications of Box&lt;Trait&gt; vs enum delegation</a></li>
<li><a href="https://www.reddit.com/r/rust/comments/74llky/trait_objects_22x_slower_than_static_dispatch/" target="_blank">trait objects: 22x slower than static dispatch?</a></li>
</ul>
<p>That third thread in particular raises a red flag. The last thing a trait should do is saddle its implementors with an extreme performance liability. Benchmarking might offer a way to dispel doubt.</p>


<h1 class="relative group">Slice-Based Iteration 
    <div id="slice-based-iteration" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#slice-based-iteration" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>At least one alternative to returning an iterator exists: return a slice instead. Clients can use exactly the same iteration pattern, while incurring none of the uncertainty of returning iterators from trait methods.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">trait</span> Owner {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// slice 🍕, not Iterator 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">ids</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">usize</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">MyOwner</span> {
</span></span><span style="display:flex;"><span>    ids: Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Owner <span style="color:#66d9ef">for</span> MyOwner {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">ids</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">usize</span>] {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>self.ids
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[test]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> owner <span style="color:#f92672">=</span> MyOwner { ids: <span style="color:#a6e22e">vec</span><span style="color:#f92672">!</span>[ <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span> ] };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    assert_eq!(owner.ids().iter().collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>(), [ <span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span> ])
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The main problem with this approach is inflexibility. What if <code>MyOwner</code> were backed by a <code>HashSet</code>, <code>HashMap</code>, or another data structure that could not return a slice of values? Returning a slice from the <code>ids</code> method leaks a detail that constrains implementations. This undermines the very reasons to use a trait in the first place.</p>


<h1 class="relative group">Two Graph Interfaces 
    <div id="two-graph-interfaces" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#two-graph-interfaces" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p><a href="https://crates.io/crates/gamma" target="_blank">Gamma</a> is a Rust crate for working with graphs. It supports the minimal graph API through its <code>Graph</code> trait. Currently (v0.9.0), that trait uses the boxed Iterator pattern for its three iteration methods:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Graph {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns true if there are no nodes, or false otherwise.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">is_empty</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">bool</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns the number of nodes in this graph.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">order</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">usize</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns the number of edges in this graph.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">size</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">usize</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns an Iterator over node identifiers.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">ids</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">dyn</span> Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">=</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns an iterator over node identifiers for the neighbors at id,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// or Error if not found.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">neighbors</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>self, id: <span style="color:#66d9ef">usize</span>
</span></span><span style="display:flex;"><span>    ) -&gt; Result<span style="color:#f92672">&lt;</span>Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">dyn</span> Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">=</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_<span style="color:#f92672">&gt;</span>, Error<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns true if id is a member, or false otherwise.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">has_id</span>(<span style="color:#f92672">&amp;</span>self, id: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#66d9ef">bool</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns the count of neighbors at id, or Error if id not found.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">degree</span>(<span style="color:#f92672">&amp;</span>self, id: <span style="color:#66d9ef">usize</span>) -&gt; Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span>, Error<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns an iterator over the edges of this graph.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">edges</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">dyn</span> Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">=</span>(<span style="color:#66d9ef">usize</span>, <span style="color:#66d9ef">usize</span>)<span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns true if the edge (sid, tid) exists, or false otherwise.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Returns Error if either sid or tid are not found.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">has_edge</span>(<span style="color:#f92672">&amp;</span>self, sid: <span style="color:#66d9ef">usize</span>, tid: <span style="color:#66d9ef">usize</span>) -&gt; Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span>, Error<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>More recently (v0.8.1), Gamma supported iteration with slices:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Graph {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns true if there are no nodes, or false otherwise.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">is_empty</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">bool</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns the number of nodes in this graph.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">order</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">usize</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns the number of edges in this graph.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">size</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">usize</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns the nodes of this graph.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">nodes</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">usize</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Iterates the neighbors of the node.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Returns an error if id not found.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">neighbors</span>(<span style="color:#f92672">&amp;</span>self, id: <span style="color:#66d9ef">usize</span>) -&gt; Result<span style="color:#f92672">&lt;&amp;</span>[<span style="color:#66d9ef">usize</span>], Error<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns true if node is a member, or false otherwise.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">has_node</span>(<span style="color:#f92672">&amp;</span>self, id: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#66d9ef">bool</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns the count of neighbors at node. REturns an error if id not
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// found.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">degree</span>(<span style="color:#f92672">&amp;</span>self, id: <span style="color:#66d9ef">usize</span>) -&gt; Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span>, Error<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns the edges of this graph.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">edges</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span>[(<span style="color:#66d9ef">usize</span>, <span style="color:#66d9ef">usize</span>)];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns true if the edge (sid, tid) exists, or false otherwise.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Returns MissingNode if either sid or tid are not members.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">has_edge</span>(<span style="color:#f92672">&amp;</span>self, sid: <span style="color:#66d9ef">usize</span>, tid: <span style="color:#66d9ef">usize</span>) -&gt; Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span>, Error<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Both versions support the same feature set, making it possible to benchmark them in a realistic setting.</p>


<h1 class="relative group">Cargo Bench 
    <div id="cargo-bench" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cargo-bench" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Cargo comes complete with its own benchmarking facility, Bencher. Unfortunately, it currently can only be used on <a href="https://rust-lang.github.io/rustup/concepts/channels.html" target="_blank">nightly</a>. Fortunately, installing nightly is simple, and once that&rsquo;s done Bencher is quite easy to use. Consider this example comparing <code>Vec</code> and <code>HashMap</code> as backing stores.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// benches/bench.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#![feature(test)]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">crate</span> test;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> test::Bencher;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[cfg(test)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> vec {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">use</span> <span style="color:#66d9ef">super</span>::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[bench]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test</span>(b: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Bencher) {
</span></span><span style="display:flex;"><span>        b.iter(<span style="color:#f92672">||</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> vec <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">1000</span> {
</span></span><span style="display:flex;"><span>                vec.push(i <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">f32</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3.5</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[cfg(test)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> hash_map {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">use</span> std::collections::HashMap;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">use</span> <span style="color:#66d9ef">super</span>::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[bench]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test</span>(b: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Bencher) {
</span></span><span style="display:flex;"><span>        b.iter(<span style="color:#f92672">||</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> map <span style="color:#f92672">=</span> HashMap::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">1000</span> {
</span></span><span style="display:flex;"><span>                map.insert(i, i <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">f32</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3.5</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Assuming that the above code has been saved in a Cargo project at <code>benches/bench.rs</code>, the benchmark can be run like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ cargo +nightly bench
</span></span><span style="display:flex;"><span>   Compiling bench_test v0.1.0 (/Users/rich/src/rust/bench_test)
</span></span><span style="display:flex;"><span>    Finished bench [optimized] target(s) in 0.86s
</span></span><span style="display:flex;"><span>     Running target/release/deps/bench_test-e50a864c98302e3c
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>running 0 tests
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>     Running target/release/deps/bench-3a4fcd802d8df8d5
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>running 2 tests
</span></span><span style="display:flex;"><span>test hash_map::test ... bench:      63,369 ns/iter (+/- 9,784)
</span></span><span style="display:flex;"><span>test vec::test      ... bench:       3,064 ns/iter (+/- 418)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>test result: ok. 0 passed; 0 failed; 0 ignored; 2 measured; 0 filtered out; finished in 8.93s
</span></span></code></pre></div><p>Bencher reports two values for each test: an execution time in nanoseconds, and a range in nanoseconds representing the difference between the maximum and minimum values. In my hands, ranges of 15-40% are seen regularly. For details, see <a href="https://stackoverflow.com/questions/48323487/how-do-i-interpret-the-output-of-cargo-bench" target="_blank">this StackOverflow thread</a>.</p>


<h1 class="relative group">Benchmarks 
    <div id="benchmarks" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#benchmarks" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Gamma is a young library and as such currently supports a small set of graph algorithms. Fortunately, two are available which represent opposite extremes in complexity: depth-first traversal and <a href="https://stackoverflow.com/questions/48323487/how-do-i-interpret-the-output-of-cargo-bench" target="_blank">maximum matching</a>. These two tasks were chosen for some simple benchmarks.</p>
<p>The benchmark project itself is <a href="https://github.com/rapodaca/gamma_bench_itervslice" target="_blank">available on GitHub</a>. A graph composed of three fused cycles, corresponding to the <a href="https://en.wikipedia.org/wiki/Fluorene" target="_blank">fluorene molecular skeleton</a> was selected for traversal and maximum matching. The benchmark consists of two separate test suites, each performing a depth-first traversal and maximum matching on this graph but using different iteration techniques.</p>
<p>On my system, the results are as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ cargo +nightly bench
</span></span><span style="display:flex;"><span>    Finished bench [optimized] target(s) in 0.00s
</span></span><span style="display:flex;"><span>     Running target/release/deps/bench-4a9b532fcd509670
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>running 0 tests
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>     Running target/release/deps/iter-11c609cfc9e969b8
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>running 2 tests
</span></span><span style="display:flex;"><span>test iter::dfs      ... bench:       5,399 ns/iter (+/- 766)
</span></span><span style="display:flex;"><span>test iter::matching ... bench:      54,178 ns/iter (+/- 19,450)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>test result: ok. 0 passed; 0 failed; 0 ignored; 2 measured; 0 filtered out; finished in 6.57s
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>     Running target/release/deps/slice-c34b3389d0e977f6
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>running 2 tests
</span></span><span style="display:flex;"><span>test slice::dfs      ... bench:       3,465 ns/iter (+/- 1,398)
</span></span><span style="display:flex;"><span>test slice::matching ... bench:      46,862 ns/iter (+/- 19,335)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>test result: ok. 0 passed; 0 failed; 0 ignored; 2 measured; 0 filtered out; finished in 0.72s
</span></span></code></pre></div><p>Absolute values differ from run to run, but in every case slice-based iteration outperforms boxed iterators. The difference is always most pronounced with depth-first traversal (about 50%), and less see with maximum matching (about 15%), although the latter are typically within the high/low range.</p>
<p>One other difference might be relevant. The boxed iterator used here clones its values, but the slice does not. To test the idea that cloning could play a role, a fork of the boxed iterator version (0.9.0) was created in which iterators return shared references (<code>Iterator&lt;Item=&amp;usize&gt;</code>). Benchmarks showed no difference in execution time.</p>
<p>The greater effect for depth-first traversal might be explained by the high relative share of iteration in that algorithm compared to maximum matching. When iteration accounts for a greater proportion of overall CPU activity, it can be expected to make a higher relative contribution to the execution time.</p>


<h1 class="relative group">Conclusion 
    <div id="conclusion" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conclusion" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Exposing iterators from Rust traits presents a set of unique problems. Two viable options are discussed in the context of a <code>Graph</code> trait: boxed Iterator trait objects and slice-based iteration. In two benchmarks, slice-based iteration outperformed boxed Iterator traits. However, the difference in execution time was most pronounced with the simpler function (about 50% vs 15%). Given more complex functions of the kind likely to be seen in real-world applications, the runtime performance gap could narrow further.</p>

          
          
          
        </div>
        
        

        
        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2021-01-27-benchmarking-two-approaches-to-iteration-from-a-rust-trait.md"
        var oid_likes = "likes_posts\/2021-01-27-benchmarking-two-approaches-to-iteration-from-a-rust-trait.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/articles/2021/01/13/matched-molecular-pairs/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Matched Molecular Pairs</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-01-13T22:00:00&#43;00:00">January 13, 2021</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/articles/2021/02/10/fast-hydrogen-counting-in-smiles/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Fast Hydrogen Counting in SMILES</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-02-10T19:30:00&#43;00:00">February 10, 2021</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="http://localhost:1313/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
