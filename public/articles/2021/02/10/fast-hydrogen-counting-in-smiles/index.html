<!DOCTYPE html>
<html lang="en-us" dir="ltr" class="scroll-smooth" data-default-appearance="light"
  data-auto-appearance="true"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en-us" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Fast Hydrogen Counting in SMILES &middot; Depth-First</title>
  <meta name="title" content="Fast Hydrogen Counting in SMILES &middot; Depth-First" />
  
  <meta name="description" content="What gets removed must be added back. The question is how?" />
  
  
  
  <link rel="canonical" href="http://localhost:1313/articles/2021/02/10/fast-hydrogen-counting-in-smiles/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.e27868ab1485f7ed7b06b122b4980bd38b19526eb8f7de885181204d28f04a0c47e9c334eff19a06c0278eb2ff8415b983a5d0fb80fd6b5680c926457cc61c57.css"
    integrity="sha512-4nhoqxSF9&#43;17BrEitJgL04sZUm64996IUYEgTSjwSgxH6cM07/GaBsAnjrL/hBW5g6XQ&#43;4D9a1aAySZFfMYcVw==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.c178288131a2f1ad46910438db47ac5f7e1c48cf949e49f6dc3310c8ec9660e23fe505805eba4e2e73711335808500360d773a2b64322feb35df52856edca286.js"
    integrity="sha512-wXgogTGi8a1GkQQ420esX34cSM&#43;Unkn23DMQyOyWYOI/5QWAXrpOLnNxEzWAhQA2DXc6K2QyL&#43;s131KFbtyihg==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="http://localhost:1313/articles/2021/02/10/fast-hydrogen-counting-in-smiles/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="Fast Hydrogen Counting in SMILES">
  <meta property="og:description" content="What gets removed must be added back. The question is how?">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-02-10T19:30:00+00:00">
    <meta property="article:modified_time" content="2021-02-10T19:30:00+00:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Fast Hydrogen Counting in SMILES">
  <meta name="twitter:description" content="What gets removed must be added back. The question is how?">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Fast Hydrogen Counting in SMILES",
    "headline": "Fast Hydrogen Counting in SMILES",
    
    "abstract": "What gets removed must be added back. The question is how?",
    "inLanguage": "en-us",
    "url" : "http:\/\/localhost:1313\/articles\/2021\/02\/10\/fast-hydrogen-counting-in-smiles\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    "copyrightYear": "2021",
    "dateCreated": "2021-02-10T19:30:00\u002b00:00",
    "datePublished": "2021-02-10T19:30:00\u002b00:00",
    
    "dateModified": "2021-02-10T19:30:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "2151"
  }]
  </script>


  
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Depth-First</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            

            </div>
        </label>
    </div>
</div>





  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Fast Hydrogen Counting in SMILES
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2021-02-10T19:30:00&#43;00:00">February 10, 2021</time><span class="px-2 text-primary-500">&middot;</span><span>2151 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">11 mins</span>
  

  
  
</div>








    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
  <div class="place-self-center">
    
    
    <div class="text-2xl sm:text-lg">
</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
    

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          <p>SMILES is the de facto standard for compact molecular representation in cheminformatics. One reason for its efficiency is <a href="/articles/2020/06/08/hydrogen-suppression-in-smiles/">hydrogen suppression</a>, which has been covered here before. Of course, the thing about leaving hydrogens out of a molecular graph is that sooner or later they&rsquo;ll need to be put back in. There are many ways to do this, with varying costs. This article takes a look at this problem and proposes a simple, efficient solution.</p>


<h1 class="relative group">But Why? 
    <div id="but-why" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#but-why" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>SMILES support is built into most cheminformatics toolkits which handle details like hydrogen counting, so why bother re-inventing the wheel?</p>
<p>It turns out that toolkits differ, <a href="https://www.slideshare.net/NextMoveSoftware/a-de-facto-standard-or-a-freeforall" target="_blank">sometimes by a lot</a>, in how they count hydrogens in molecules built from SMILES. The situation has improved over the years, but issues remain. Knowing how to count hydrogens can help you debug problems seen in the wild.</p>
<p>Then there&rsquo;s performance. Cheminformatics toolkits are useful, but their generality incurs overhead. If your goal is to compute a molecular mass, a molecular formula, hydrogen bond donor-acceptor sets, or other descriptors, a cheminformatics toolkit may be overkill. Directly processing strings with an efficient low-level toolkit such as <a href="https://crates.io/crates/purr" target="_blank">Purr</a> may be all that&rsquo;s needed. Cutting corners becomes safer when you know the rules and risks.</p>


<h1 class="relative group">Implicit Hydrogens 
    <div id="implicit-hydrogens" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#implicit-hydrogens" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>SMILES supports two forms of hydrogen suppression:</p>
<ol>
<li><em><a href="/articles/2019/11/06/virtual-hydrogens/">Virtual Hydrogens</a></em>. These hydrogens are defined as an attribute of a bracket atom. For example, the SMILES string <code>[CH4]</code>, assigns the carbon atom a virtual hydrogen count of four. The virtual hydrogen count of unbracketed atoms is zero.</li>
<li><em>Implicit Hydrogens</em>. These hydrogens are obtained through computation on a bare (non-bracket) atom. For example, <code>C</code> defines a carbon atom with an implicit hydrogen count of four. The implicit hydrogen count of bracketed atoms is zero.</li>
</ol>
<p>Unlike virtual hydrogens, implicit hydrogens can only be counted using information outside of the SMILES representation itself.</p>


<h1 class="relative group">SMILES Valence Model 
    <div id="smiles-valence-model" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#smiles-valence-model" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>SMILES solves the implicit hydrogen counting problem through its <em>valence model</em>. A valence model consists of two components: (1) a target valence table consisting of one or more target valences for each covered element; and (2) rules for using the target valence table.</p>
<p>The SMILES target valence table is:</p>
<!-- raw HTML omitted -->
<p>The target valence table defines all of valence states covered by the model. If an element does not appear in the table, it&rsquo;s not part of the valence model.</p>
<p>To a first approximation, we compute implicit hydrogen count with the following procedure:</p>
<ol>
<li>Find the entry in the target valence table corresponding to the atom&rsquo;s elemental symbol.</li>
<li>Find the atom&rsquo;s <em>valence</em> as the sum of bond orders.</li>
<li>Find the smallest target valence greater than or equal to the valence. This is the atom&rsquo;s target valence.</li>
<li>If no target valence exists, report an implicit hydrogen count as zero.</li>
<li>Report implicit hydrogen count as target valence minus valence.</li>
</ol>
<p>Consider methane (<code>C</code>). It has only one target valence entry, 4. The valence for this atom is zero because there it has no bonds. The target valence is four because that&rsquo;s the only entry. The implicit hydrogen count is therefore 4 (4 - 0).</p>
<p>A trickier example is tetramethylnitrogen (<code>N(C)(C)(C)C</code>). Nitrogen has two target valences (3 and 5). The valence for the nitrogen atom is four. The target valence is 5 because it&rsquo;s the smallest target that doesn&rsquo;t exceed the valence. The hydrogen count on nitrogen is therefore 1 (5 - 4). This may seem counterintuitive, but it&rsquo;s important to realize that in the absence of an explicit charge present within a bracket atom, all SMILES atoms are neutral.</p>
<p>The rules presented here provide a good start, but there&rsquo;s more to the picture.</p>


<h1 class="relative group">Aromaticity 
    <div id="aromaticity" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#aromaticity" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>All is well and good with the SMILES valence model until we encounter <em>unbracketed aromatics</em>, which are written as with lowercase letters (b, c, n, o, p, s). Consider fluorobenzene (<code>Fc1ccccc1</code>). All atoms are unbracketed, but what are the implicit hydrogen counts for the aromatic carbons?</p>
<p>Naively applying the valence model from the previous section yields an unsatisfactory answer:</p>
<ul>
<li>atom(1): 1H (0H expected)</li>
<li>atom(2) - atom(6): 2H (1H expected)</li>
</ul>
<p>What&rsquo;s missing is a <em><a href="/articles/2020/02/10/a-comprehensive-treatment-of-aromaticity-in-the-smiles-language/">kekulization</a></em> step. Kekulization transforms a representation containing aromatic features into one that does not. This typically involves the promotion of the orders of alternating bonds from single to double. For example, kekulization of fluorobenzene comprised of lowercase carbons (<code>Fc1ccccc1</code>) yields <code>FC1=CC=CC=C1</code> as one option.</p>
<p>Kekulization is a non-trivial operation in the general case. It requires a solution to the <a href="/articles/2019/04/02/the-maximum-matching-problem/">maximum matching problem</a>, typically through the application of <a href="/articles/2020/09/28/edmonds-blossom-algorithm-part-1-cast-of-characters/">Edmonds&rsquo; Algorithm</a>. For large aromatic ring systems such as those found in polycyclic aromatic hydrocarbons, fullerenes, and nanotubes, the computational cost can be substantial.</p>
<p>Kekulization just for the sake of counting hydrogens will be overkill in many situations. Fortunately, there is an alternative.</p>


<h1 class="relative group">Cutting Corners 
    <div id="cutting-corners" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cutting-corners" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Although kekulization itself can be costly, the net result is rather simple. Either a given atom&rsquo;s valence will increase by one or it won&rsquo;t. To understand why, recall that kekulization can only increment the order of at most one bond attached to a given atom. If more than one bond were promoted to a double bond at a single atom, that would lead to non-alternating double bonds.</p>
<p>The bonds of some atoms will remain unchanged after kekulization. Fortunately, they are easy to identify. The bonds of an atom whose current valence is equal to a target valence, or greater than the maximum target valence, will not be incremented. Doing so would lead minefield of problems that SMILES avoids, albeit implicitly.</p>
<p>In other words, we can avoid kekulization entirely by considering the much simpler problem of whether an atom&rsquo;s current valence is equal to a target valence or greater than the maximum target valence. If so, the atom&rsquo;s valence will not be incremented as a result of kekulization.</p>
<p>For example, furan can be encoded with lowercase atoms (<code>o1cccc1</code>). The oxygen atom has a valence of 2 and a target of 2. Therefore, the oxygen atom&rsquo;s valence will not increase after kekulization. The carbon atoms on the other hand each have a valence (2) that is less than the target valence (4). These atoms&rsquo; valence will increase by one after kekulization.</p>


<h1 class="relative group">Subvalence 
    <div id="subvalence" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#subvalence" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>There&rsquo;s a foundational concept hiding just below the surface of all this, something I call <em>subvalence</em>. Subvalence is a non-negative integer representing the number of valence increases an atom can undergo without exceeding its current target valence. If valence already exceeds the maximum target, subvalence is zero.</p>
<p>Subvalence helps formalize the rules around implicit hydrogen counting for aromatics. If an aromatic atom&rsquo;s subvalence is greater than one, report implicit hydrogen count as subvalence minus one. Otherwise, implicit hydrogen count is zero.</p>
<p>Returning to the example of furan (<code>o1cccc1</code>), the oxygen atom has a subvalence of zero, so its implicit hydrogen count is also zero. Each carbon atom reports a subvalence of two, so the implicit hydrogen count will be one (2 - 1).</p>
<p>Tangentially, subvalence can also be used during kekulization. Atoms with zero subvalence are not considered for bond order adjustment. For example, the oxygen atom of furan would not participate in bond order promotion, but the carbon atoms would.</p>


<h1 class="relative group">Expanded Rules 
    <div id="expanded-rules" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#expanded-rules" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Putting everything together, we obtain the following revised set of rules for computing the implicit hydrogen count of an unbracketed atom.</p>
<!-- raw HTML omitted -->
<ol>
<li>Find the entry in the table corresponding to the atom&rsquo;s elemental symbol.</li>
<li>Find the atom&rsquo;s <em>valence</em> as the sum of bond orders.</li>
<li>Find the smallest target valence greater than or equal to the valence. This is the atom&rsquo;s target valence.</li>
<li>If no target valence exists, report an implicit hydrogen count of zero.</li>
<li>Compute subvalence by subtracting valence from target valence.</li>
<li>If the atom is not lowercase, report implicit hydrogen count as subvalence.</li>
<li>If the atom is lowercase, report implicit hydrogen count as either subvalence minus one for subvalences greater than one, or zero.</li>
</ol>
<p>To be clear, these rules apply only unbracketed atoms. The star atom (<code>*</code>) and all bracket atoms always have an implicit hydrogen count of zero.</p>


<h1 class="relative group">Valence 
    <div id="valence" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#valence" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The procedure described here assumes a reliable method for computing valence. Valence is a computation that sums an atom&rsquo;s bond orders. SMILES lacks the concept of bond order, instead defining one of eight bond types. The trick is to derive a reasonable bond order from each type. Here&rsquo;s one approach:</p>
<ul>
<li>single (<code>-</code>): 1</li>
<li>double (<code>=</code>): 2</li>
<li>triple (<code>#</code>): 3</li>
<li>quadruple (<code>$</code>): 4</li>
<li>up (<code>/</code>): 1</li>
<li>down (<code>\\</code>): 1</li>
<li>elided (blank): 1</li>
<li>aromatic (<code>:</code>): 1</li>
</ul>
<p>These assignments, together with the rest of the valence model presented here, reproduce the implicit hydrogen behavior of major implementations and the documentation available from Daylight and OpenSMILES.</p>
<p>However, SMILES is a language with a universe of representations whose meaning and even validity are far from clear. Consider these examples, in which bond types other than aromatic or elided appear between lowercase atoms:</p>
<ul>
<li><code>c1cc-ccc1</code>. There is a maximum matching that produces benzene, but there is also one that must promote an explicit single bond to a double bond. Implicit hydrogen count is one either way.</li>
<li><code>c1cc=ccc1</code>. There is a maximum matching that produces benzene, but there is also one that produces <em>benzyne</em> by promoting the explicit double bond. Implicit hydrogen counts are one and zero, respectively.</li>
<li><code>c1cc#ccc1</code>. Some attempts to kekulize will lead to pentavalent carbon, others to benzyne. Implicit hydrogen count will be zero either way.</li>
</ul>
<p>Unfortunately, SMILES descriptions are for the most part silent on this topic. Neither descriptions nor examples appear in <a href="https://www.daylight.com/dayhtml/doc/theory/theory.smiles.html" target="_blank">Daylight online documentation</a>, <a href="https://doi.org/10.1021/ci00057a005" target="_blank">Weininger&rsquo;s SMILES paper</a>, and <a href="http://doi.wiley.com/10.1002/9783527618279.ch5" target="_blank">Weiningers extended description</a>.</p>
<p><a href="http://opensmiles.org/opensmiles.html" target="_blank">OpenSMILES</a> partially addresses the issue by explaining that at least the single bond type between two lowercase atoms, as in biphenyl (<code>c1ccccc1-c2ccccc2</code>), is legal:</p>
<blockquote>
<p>&ldquo;&hellip; a bond between two aromatic atoms is assumed to be aromatic unless it is explicitly represented as a single bond &lsquo;-&rsquo;. However, a single bond (nonaromatic bond) between two aromatic atoms must be explicitly represented. &hellip;</p>
</blockquote>
<p>How should we interpret <code>c1cc-ccc1</code> in light of this guidance? It&rsquo;s not clear because the meaning of &ldquo;assumed to be aromatic&rdquo; isn&rsquo;t clear. If the meaning is that the bond order of the single bond can never be promoted, then application of the maximum matching procedure leads to a specific kekule form of benzene and all is well. However, extending this interpretation to <code>c1cc=ccc1</code> leads to a cyclocumulene (<code>C=1C=C=C=CC=1</code>) and an implicit hydrogen count of zero. The contradiction remains.</p>
<p>In a 2017 presentation, Noel O&rsquo;Boyle <a href="https://www.slideshare.net/baoilleach/we-need-to-talk-about-kekulization-aromaticity-and-smiles" target="_blank">reiterated the OpenSMILES interpretation</a>. In a nutshell, it states that the single bond type is not to be promoted to a double bond through kekulization. Its terminal atoms may contain other bonds that will be promoted. One motivation could be improved performance. In biphyenylene the technique restricts the range of possible mesomers, which may be helpful for depiction.</p>
<!-- raw HTML omitted -->
<p>Then there&rsquo;s the aromatic bond (<code>:</code>). What&rsquo;s its purpose? In one interpretation, it does nothing at all - ever. In another, it could signify that non-lowercase terminals should be eligible for kekulization, as if they were written lowercase. Sources have something to say, but not much.</p>
<p>OpenSMILES instructs:</p>
<blockquote>
<p>The aromatic-bond symbol &lsquo;:&rsquo; can be used between aromatic atoms, but it is never necessary &hellip;</p>
</blockquote>
<p>Weininger&rsquo;s original SMILES paper notes:</p>
<blockquote>
<p>Single and aromatic bonds may be, and usually are, omitted.</p>
</blockquote>
<p>In other words, the aromatic bond is optional in the same way that a single bond is optional. The SMILES strings <code>c:1:c:c:c:c:c:1</code> and <code>c1ccccc1</code> both represent the same molecule, benzene, just like <code>C-1-C-C-C-C-C-1</code> and <code>C1CCCCC1</code> both represent cyclohexane. As far as fast hydrogen counting is concerned, an aromatic bond behaves like an elided or single bond.</p>
<p>What isn&rsquo;t clear is the meaning of a SMILES like <code>C:1:C:C:C:C:C:1</code>. Is this benzene or cyclohexane? Is it even valid? A small Twitter survey illustrates the confusion:</p>
<!-- raw HTML omitted -->
<p>Depending on your perspective on these topics, the procedure you use for hydrogen counting may need to be adapted.</p>


<h1 class="relative group">Limitations 
    <div id="limitations" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#limitations" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The main limitation of the procedure outlined here is that the aromatic Ï€-system of the SMILES representation never gets validated. This is but one of numerous semantic issues that can consume a rather large number of lines of code, such as: ring closure digits that don&rsquo;t match or which are duplicated on the same atom; negative implied neutron count; negative implied valence electron count; and so on. If you doubt the quality of the SMILES you&rsquo;re working with, you may need a more comprehensive solution.</p>


<h1 class="relative group">Previous Work 
    <div id="previous-work" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#previous-work" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>To my knowledge, the first mention of the basic idea presented here occurred on the <a href="https://sourceforge.net/p/blueobelisk/mailman/blueobelisk-smiles/thread/60825b0f0709302037g2d68f2eamdb5ebecf3baea6d1@mail.gmail.com/" target="_blank">OpenSMILES mailing list</a>. The proposal there differs from the one here in some important ways. More recently, <a href="http://efficientbits.blogspot.com/2013/09/smiles-implicit-valence-of-aromatic.html" target="_blank">John Mayfield</a> proposed a similar idea, along with a few alternatives.</p>


<h1 class="relative group">Conclusions 
    <div id="conclusions" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conclusions" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Implicit atomic hydrogen count is a computed property in SMILES. The computation is straightforward for bracket and aliphatic atoms, but more complicated for aromatics. The problem can be efficiently solved in most cases by correcting for the effect of kekulization. Ambiguous meaning and/or validity of certain SMILES constructs means taking a stand, but this is no different than using a toolkit.</p>

          
          
          
        </div>
        
        

        
        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2021-02-10-fast-hydrogen-counting-hydrogens-in-smiles.md"
        var oid_likes = "likes_posts\/2021-02-10-fast-hydrogen-counting-hydrogens-in-smiles.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/articles/2021/01/26/benchmarking-iteration-from-a-rust-trait/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Benchmarking Iteration from a Rust Trait</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-01-26T19:00:00&#43;00:00">January 26, 2021</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/articles/2021/03/03/purr-a-smiles-toolkit-for-rust/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Purr: A SMILES Toolkit for Rust</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-03-03T17:00:00&#43;00:00">March 3, 2021</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="http://localhost:1313/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
