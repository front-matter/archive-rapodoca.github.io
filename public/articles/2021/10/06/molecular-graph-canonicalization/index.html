<!DOCTYPE html>
<html lang="en-us" dir="ltr" class="scroll-smooth" data-default-appearance="light"
  data-auto-appearance="true"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en-us" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Molecular Graph Canonicalization &middot; Depth-First</title>
  <meta name="title" content="Molecular Graph Canonicalization &middot; Depth-First" />
  
  <meta name="description" content="Building a mental model for fast graph comparison techniques." />
  
  
  
  <link rel="canonical" href="http://localhost:1313/articles/2021/10/06/molecular-graph-canonicalization/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.e27868ab1485f7ed7b06b122b4980bd38b19526eb8f7de885181204d28f04a0c47e9c334eff19a06c0278eb2ff8415b983a5d0fb80fd6b5680c926457cc61c57.css"
    integrity="sha512-4nhoqxSF9&#43;17BrEitJgL04sZUm64996IUYEgTSjwSgxH6cM07/GaBsAnjrL/hBW5g6XQ&#43;4D9a1aAySZFfMYcVw==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.c178288131a2f1ad46910438db47ac5f7e1c48cf949e49f6dc3310c8ec9660e23fe505805eba4e2e73711335808500360d773a2b64322feb35df52856edca286.js"
    integrity="sha512-wXgogTGi8a1GkQQ420esX34cSM&#43;Unkn23DMQyOyWYOI/5QWAXrpOLnNxEzWAhQA2DXc6K2QyL&#43;s131KFbtyihg==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="http://localhost:1313/articles/2021/10/06/molecular-graph-canonicalization/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="Molecular Graph Canonicalization">
  <meta property="og:description" content="Building a mental model for fast graph comparison techniques.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-10-06T17:30:00+00:00">
    <meta property="article:modified_time" content="2021-10-06T17:30:00+00:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Molecular Graph Canonicalization">
  <meta name="twitter:description" content="Building a mental model for fast graph comparison techniques.">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Molecular Graph Canonicalization",
    "headline": "Molecular Graph Canonicalization",
    
    "abstract": "Building a mental model for fast graph comparison techniques.",
    "inLanguage": "en-us",
    "url" : "http:\/\/localhost:1313\/articles\/2021\/10\/06\/molecular-graph-canonicalization\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    "copyrightYear": "2021",
    "dateCreated": "2021-10-06T17:30:00\u002b00:00",
    "datePublished": "2021-10-06T17:30:00\u002b00:00",
    
    "dateModified": "2021-10-06T17:30:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "2585"
  }]
  </script>


  
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Depth-First</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            

            </div>
        </label>
    </div>
</div>





  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Molecular Graph Canonicalization
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2021-10-06T17:30:00&#43;00:00">October 6, 2021</time><span class="px-2 text-primary-500">&middot;</span><span>2585 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">13 mins</span>
  

  
  
</div>








    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
  <div class="place-self-center">
    
    
    <div class="text-2xl sm:text-lg">
</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
    

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          <p>Many kinds of molecular encoding are used in cheminformatics, but all are based on the concept of a molecular graph. A molecular graph is a graph whose nodes and edges are augmented to capture information relevant to molecular structure. Generally speaking, atoms map to nodes and bonds map to edges.</p>
<p>Comparing two graphs for equivalence turns out to be challenging compared to other kinds of comparisons. Data structures like lists (e.g, strings and arrays) offer a simple, linear time approach: iterate the elements of both lists in parallel, returning false at the first mismatch or true if no mismatch is found. This linear approach is not directly applicable to graph comparisons, but with some work the problem can be recast as a linear search. This article describes the idea at a high level, offering a simple conceptual framework for a rather large body of literature.</p>


<h1 class="relative group">Applications 
    <div id="applications" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#applications" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Before diving into solutions, it&rsquo;s worth noting some situations in which graph equivalence crops up. Most applications of graph equivalence arise in the context of creating and using molecular sets. A set contains no duplicates, so a molecular set requires a method for comparing two molecular graphs for equivalence. Such comparisons must occur whenever a member is added, removed, edited, or queried. Molecular sets are widely used in cheminformatics.</p>
<p>One of the most import kinds of molecular set is the <em>registration system</em>. A registration system is a molecular set used by an organization to enforce not just graph equivalence, but more restrictive business rules as well. These often involve the perception of tautomerism, stereoisomerism, salt forms, and other higher forms of equivalence. Registration systems are typically complex, with layers of protocol for read and write access. An example is the <a href="https://www.cas.org/cas-data/cas-registry" target="_blank">Chemical Abstracts Service Registry</a>. This registration system contains over 188 million substances, many of which are represented as graphs. Pharmaceutical companies typically maintain their own registration systems, each with a slightly different set of business rules.</p>
<p>But molecular sets that act like registries can follow much simpler rules as well. Here are but a few examples:</p>
<ul>
<li><a href="/articles/2021/06/04/molecular-assembly-index/">Molecular Assembly Index</a>, a topic recently covered here, uses the presence of a newly-generated molecule in a collection as the basis for a metric of molecular complexity relevant to the origins of life.</li>
<li>Mapping chemical structure to properties requires a suitable method to identify and prevent duplicates. This topic lies in the vast area known as <a href="/articles/2020/07/27/a-guide-to-molecular-standardization/">molecular standardization</a>.</li>
<li>The enumeration of the members of any chemical space, regardless of size, requires a method to identify and eliminate duplicates. <a href="https://dx.doi.org/10.1021/ci300415d#" target="_blank">GDB</a> is one example.</li>
</ul>
<p>The need to check for molecular equivalence is pervasive in cheminformatics because molecular sets tend to show up wherever molecular graphs do.</p>


<h1 class="relative group">Automorphism 
    <div id="automorphism" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#automorphism" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Up to this point I&rsquo;ve been using the term &ldquo;equivalent&rdquo; rather loosely. What I mean is <em>automorphic</em>. <a href="https://en.wikipedia.org/wiki/Automorphism" target="_blank">Automorphism</a> occurs when a graph is found to be isomorphic with itself. Like isomorphism, automorphism is associated with a mapping (or &ldquo;permutation&rdquo;) of atoms from query to target graph. Because each represents the same graph, an automorphism maps each node to either itself or another member node.</p>
<!-- raw HTML omitted -->
<p>A permutation can be thought of as an ordering the nodes of a graph. Imagine that we find an automorphism between two graphs of six nodes: (0→5); (1→1); (2→0); (3→3); (4→2); (5→4). An equivalent form would be the array <code>[5, 1, 0, 3, 2, 4]</code>. The array form reveals that under the mapping node 5 comes first, followed by nodes 1, 0, 3, 2, and 4, in that order.</p>
<p>Something interesting happens when the mappings for two automorphic graphs with identical node orderings are exhaustively enumerated. The result is an <em><a href="https://en.wikipedia.org/wiki/Automorphism_group" target="_blank">automorphism group</a></em>. An automorphism group partitions the nodes of a graph into equivalent sets (aka &ldquo;orbits&rdquo;). The number of orbits and their occupancy describes the symmetry properties of a graph. As we&rsquo;ll see, the automorphism group also plays important role in graph equivalence problem.</p>
<!-- raw HTML omitted -->


<h1 class="relative group">Brute-Forcing Automorphism 
    <div id="brute-forcing-automorphism" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#brute-forcing-automorphism" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Brute force is an effective method for determining whether two graphs of equal size and order, <code>A</code> and <code>B</code>, are automorphic. Pick a random node from <code>A</code> and call it <code>a</code>. Pick a random node from <code>B</code> and call it <code>b</code>. Do all relevant local properties of <code>a</code> and <code>b</code> match (e.g., degree, atomic number, charge, isotope, stereochemical configuration)? If <code>a</code> and <code>b</code> don&rsquo;t match, pick another node from <code>B</code> and try again. If <code>a</code> and <code>b</code> do match, pick a random neighbor of <code>a</code>, pick a random neighbor of <code>b</code>, and try to match them. Continue this process, backing out and retrying again as needed, until either all nodes have been matched or no matching node <code>b</code> can be found.</p>
<p>A procedure very much like this one underpins the <a href="/articles/2008/11/13/one-of-these-things-is-not-like-the-other/">VF2 and Ullmann</a> algorithms. These algorithms are designed for the more general problem of isomorphism. Brute force is the only option when query and target graphs have unequal sizes (edge count), orders (node counts), or both. However, when node and edge counts are identical across query and target, as they are in the case of automorphism, we can do better.</p>


<h1 class="relative group">Canonicalization 
    <div id="canonicalization" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#canonicalization" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The efficiency of detecting an automorphism condition can be increased through <em><a href="https://en.wikipedia.org/wiki/Canonicalization" target="_blank">canonicalization</a></em>. In the context of graphs, canonicalization is the process of selecting one representation out of all possible representations. This is usually accomplished through the identification of an ordering of nodes that leads to the canonical form. For example, methanol has two possible representations: one in which the atom ordering places carbon ahead of oxygen, and one which places oxygen ahead of carbon. Each ordering leads to a different representation.</p>
<!-- raw HTML omitted -->
<p>It turns out that this problem can be transformed into one that looks more like list comparison through canonicalization. Canonicalize both graphs, <code>A</code> and <code>B</code>, then compare each list of atoms. At the first mismatch, report no automorphism, otherwise report that an automorphism exists.</p>
<p>At first glance, this operation may not appear to have achieved much. We must still canonicalize both the query and target graphs. That doesn&rsquo;t come cheap. Recall, however, the context in which most automorphism comparisons occur: molecular sets. The canonical form of all members can be computed and cached. Querying the set boils down to canonicalizing the query graph and performing a list-like comparison operation over the set. This approach really shines when seeking the intersection of two molecular sets as when two registry systems are merged or joined. In this sense, a canonicalized graph serves as a kind of <a href="https://en.wikipedia.org/wiki/Foreign_key" target="_blank">foreign key</a>. Not only that, but we can take advantage of <a href="https://en.wikipedia.org/wiki/Hash_function" target="_blank">hashing</a> to perform extremely efficient molecular lookups. This offers <a href="https://en.wikipedia.org/wiki/Primary_key" target="_blank">primary key</a> functionality.</p>
<p>All it takes to get these benefits is a canonicalization algorithm.</p>


<h1 class="relative group">Brute Forcing Canonicalization 
    <div id="brute-forcing-canonicalization" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#brute-forcing-canonicalization" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Many canonicalization algorithms have been developed. Like isomorphism algorithms, each canonicalization algorithm has at its core a simple kernel that can be expressed as a brute force procedure. For canonicalization, that kernel is the generation of a <em>code</em>.</p>
<p>As defined by <a href="https://doi.org/10.1002/9783527618279.ch7a" target="_blank">Ivanciuc</a>, a code is a string (character sequence) obtained through algorithmic transformation of a graph. A code has the useful property of being transformable into the graph that generated it. For example, <a href="/articles/2021/09/22/beyond-smiles/">SMILES</a> fits the definition of a molecular code. Molecular graphs can be transformed to and from SMILES representation algorithmically. InChI, on the other hand, does not qualify as a code because <a href="/articles/2021/03/10/parsing-inchi-its-complicated/">an InChI string can&rsquo;t be transformed, generally speaking, into a molecular graph</a>. An InChI with &ldquo;auxiliary information,&rdquo; however, does qualify as a code, a feature that was successfully used to <a href="https://doi.org/10.1186/1758-2946-4-22" target="_blank">generate canonical SMILES using InChI</a>.</p>
<p>The availability of a molecular coding scheme like SMILES makes it possible to define a brute force canonicalization algorithm for a molecular graph <code>G</code>:</p>
<ol>
<li>Generate the set of all possible SMILES, <code>S</code>, from <code>G</code>.</li>
<li>Select the <a href="https://en.wikipedia.org/wiki/Lexicographic_order" target="_blank">lexicographically smallest</a> SMILES, <code>s</code>, from <code>S</code>. The order of characters can be derived from <a href="https://en.wikipedia.org/wiki/ASCII" target="_blank">ASCII</a>.</li>
<li>The canonical form of <code>G</code> is the molecular graph that results from reading <code>s</code>.</li>
</ol>
<p>Imagine using this procedure to canonicalize isopropanol. We begin by generating all possible SMILES:</p>
<ul>
<li>OC(C)C</li>
<li>CC(C)O</li>
<li>CC(O)C</li>
<li>C(C)(C)O</li>
<li>C(O)(C)C</li>
</ul>
<p>The ASCII character set associates each character with a unique number. The parentheses symbols precede the letters, with the left parentheses symbol (<code>(</code>) preceding the right (<code>)</code>). The SMILES for isopropanol can therefore be sorted in ascending lexicographical order as follows:</p>
<ol>
<li>C(C)(C)O</li>
<li>C(O)(C)C</li>
<li>CC(C)O</li>
<li>CC(O)C</li>
<li>OC(C)C</li>
</ol>
<p>From this ranking we conclude that the canonical form of isopropanol is the one produced from reading the SMILES <code>C(C)(C)O</code>.</p>
<p>Using this procedure requires some attention to detail. For example, it&rsquo;s important to ensure that the rules explicitly state when and how <a href="/articles/2020/06/08/hydrogen-suppression-in-smiles/">hydrogen suppression</a> may be used. Likewise, we&rsquo;d want to ensure that ring closure digits followed a set of consistent rules to avoid useless diversity.</p>
<p>The main problem with the brute force approach as stated is inefficiency. A given molecular graph with <em>n</em> nodes will have up to <em>n</em>! different node orderings. For example, isopropanol with four heavy atoms has 24 (4!) possible orderings. This <em>factorial</em> scaling of the number of atom orderings bodes poorly for the brute force method.</p>
<p>Notice, however, that only five unique SMILES for isopropanol are enumerated by brute force. What&rsquo;s going on here? The answer is twofold: syntax and symmetry.</p>
<p>SMILES encoding yields atom indexes that follow a depth-first traversal pattern. This pattern eliminates many otherwise valid atom orderings. For example, it would be impossible to express a SMILES for isopropanol in which a primary carbon immediately preceded the oxygen atom because these two atoms are not bound to each other.</p>
<p>A second factor is symmetry. Take the canonical SMILES, <code>C(C)(C)O</code>, for example. This form actually represents two equivalent numberings due to the topological equivalence of the methyl groups. Each of the five candidates in fact represents two different atom numbering systems due to symmetry. Symmetry reduced ten possible SMILES candidates to five.</p>


<h1 class="relative group">Optimization Strategies 
    <div id="optimization-strategies" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#optimization-strategies" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>SMILES syntax and molecular topological equivalence act to reduce the number of candidate SMILES. What other rules could be applied to further reduce the search space? What would it take to reduce the search space to one candidate? These are questions related to optimization.</p>
<p>As mentioned previously, SMILES offers a powerful type of optimization essentially for free, by virtue of its its syntax. That optimization eliminates atom orderings that can&rsquo;t follow from a depth-first traversal.</p>
<p>We can view the enumeration of all possible SMILES as a set of search trees, each one rooted at a starting atom. Each tree is terminated by a different candidate SMILES. What we&rsquo;d like is a set of procedures that terminate the exploration of a search tree at the earliest possible point.</p>
<p>The question then becomes, what other optimizations can be applied to terminate the exploration of unproductive search trees?</p>


<h1 class="relative group">Invariants 
    <div id="invariants" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#invariants" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The process of optimizing molecular canonicalization often begins with <em>graph invariants</em>. An invariant is a property of a graph that does not change with node ordering.</p>
<p>Take the number of nodes of a graph (aka &ldquo;order&rdquo;), for example. Regardless of how nodes are ordered, the total number of nodes never changes. The same applies to edge count. But even though they are invariant, node and edge counts won&rsquo;t help us create more efficient canonicalization schemes.</p>
<p>What will help are invariants that can partition atoms. For example, degree is the number of neighbors attached to a node. Regardless of what index it carries, the degree of a node remains constant. Atomic number is another graph invariant. Regardless of how a molecular graph is encoded, the atomic number of its atoms will never change. Other atom invariants include isotope and charge.</p>
<!-- raw HTML omitted -->
<p>A large number of graph invariants have been described over the last few decades, many in the context of molecular graphs. For example, the idea of degree can be generalized to <em>extended connectivity</em>. Whereas degree only takes into account the connectivity of a given atom, extended connectivity accounts for the connectivity of neighbors, their neighbors and so on.</p>
<p>To illustrate, consider an alternative definition of degree. Begin by labeling each atom with the index 1. Now compute the degree of a given atom as the sum of each neighbor&rsquo;s index. The tertiary carbon in isopropanol, for example, has three neighbors, each having an index of one. The degree of the tertiary carbon is therefore three (3*1).</p>
<!-- raw HTML omitted -->
<p>Extended connectivity takes this idea one step further by introducing iterations. After the first iteration, update the index of each atom with the result of the previous calculation. For the second iteration (<code>i</code>=1), this is the degree of each atom. Continue iterating until the number of unique indexes does not increase. This is the basis for the well-known <em><a href="https://dx.doi.org/10.1021/c160017a018" target="_blank">Morgan Algorithm</a></em>.</p>
<!-- raw HTML omitted -->
<p>Another node invariant is <em>distance sum</em>. The distance sum for a node is the sum of all shortest path lengths to every other node. Computing this invariant requires <em>n</em> - 1 breadth-first traversals for every node and so scales quadratically with the number of nodes.</p>
<!-- raw HTML omitted -->
<p>Some molecules possess features that cause many atoms to resist symmetry partitioning. Consider cubane, whose eight carbon atoms are topologically equivalent. None of the invariants so far described can differentiate these atoms. Nor is cubane the only example. Fullerenes such as C<!-- raw HTML omitted -->60<!-- raw HTML omitted --> are composed of large numbers of topologically equivalent atoms. Fortunately, the selection of the first atom can <a href="https://hrcak.srce.hr/2536" target="_blank">impose asymmetry</a> which, when coupled with iterative comparison, leads to efficient pruning of the search tree.</p>
<p>Degree, extended connectivity, and distance sum are but some examples of the invariants that can be applied to optimize a canonicalization algorithm.</p>


<h1 class="relative group">Choosing a Node 
    <div id="choosing-a-node" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#choosing-a-node" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Given that SMILES strings derive from a depth-first traversal of a molecular graph, the selection of the starting node would seem to offer a good place to look for optimizations. In fact, the careful selection of the starting node can prune entire branches of the search space.</p>
<p>Recall that the candidate SMILES strings for isopropanol, ranked in ascending lexicographical order, are:</p>
<ol>
<li>C(C)(C)O</li>
<li>C(O)(C)C</li>
<li>CC(C)O</li>
<li>CC(O)C</li>
<li>OC(C)C</li>
</ol>
<p>Some of the simple invariants that might be considered when choosing the first atom include:</p>
<ul>
<li>Degree. Starting with the atom of highest degree reduces the number of candidates to two: 1 and 2.</li>
<li>Atomic number. Starting with the atom of highest atomic number reduces the candidates to just one: 5.</li>
<li>Extended connectivity. Starting with the atom of highest extended connectivity reduces the number of candidates to two: 1 and 2.</li>
<li>Distance sum.  Starting with the atom of lowest distance sum reduces the number of candidates to two: 1 and 2.</li>
</ul>
<p>These invariants can be (and often are) combined in various ways. For example, <a href="https://doi.org/10.1021/ci00062a008" target="_blank">Weininger</a> uses the invariants: degree; <a href="/articles/2019/11/06/virtual-hydrogens/">virtual hydrogen count</a>; graph hydrogen count; atomic number; sign of charge; absolute charge; and total hydrogen count.</p>
<p>Depending on the desired level of optimization, still more invariants can be brought into play, mixed, and matched. Unfortunately, reports of such optimizations often don&rsquo;t reveal performance benchmarks, which complicates evaluation.</p>
<p>When selecting subsequent atoms, either the same invariant set or a different one can be used. Additional heuristics can also be brought into play. For example, we might prefer to traverse nodes connected to previously-traversed nodes.</p>
<p>Note that a valid canonicalization will result even from invariants of low discriminatory ability. Clearly, a brute force procedure without invariants works just fine. The selection of invariants isn&rsquo;t about obtaining a valid result, but rather obtaining it more efficiently.</p>


<h1 class="relative group">Conclusion 
    <div id="conclusion" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conclusion" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Molecular canonicalization is a complex topic, but fortunately the underlying principles are easy to understand. This article presents a mental model for canonicalization that uses a brute force approach as the base case. From that base, the various optimizations that have been developed over the last few decades can be explored.</p>

          
          
          
        </div>
        
        

        
        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2021-10-06-molecular-graph-canonicalization.md"
        var oid_likes = "likes_posts\/2021-10-06-molecular-graph-canonicalization.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/articles/2021/09/22/beyond-smiles/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Beyond SMILES</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-09-22T17:30:00&#43;00:00">September 22, 2021</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/articles/2021/10/21/types-without-typescript/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Types without TypeScript</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-10-21T02:30:00&#43;00:00">October 21, 2021</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="http://localhost:1313/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
