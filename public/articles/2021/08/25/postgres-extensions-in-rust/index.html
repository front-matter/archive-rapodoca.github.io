<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Postgres Extensions in Rust | Depth-First</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Opening a new path to high-performance, domain-specific database applications.">
    <meta name="generator" content="Hugo 0.139.4">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/articles/2021/08/25/postgres-extensions-in-rust/">
    

    <meta property="og:url" content="http://localhost:1313/articles/2021/08/25/postgres-extensions-in-rust/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="Postgres Extensions in Rust">
  <meta property="og:description" content="Opening a new path to high-performance, domain-specific database applications.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="articles">
    <meta property="article:published_time" content="2021-08-25T15:00:00+00:00">
    <meta property="article:modified_time" content="2021-08-25T15:00:00+00:00">

  <meta itemprop="name" content="Postgres Extensions in Rust">
  <meta itemprop="description" content="Opening a new path to high-performance, domain-specific database applications.">
  <meta itemprop="datePublished" content="2021-08-25T15:00:00+00:00">
  <meta itemprop="dateModified" content="2021-08-25T15:00:00+00:00">
  <meta itemprop="wordCount" content="1020">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Postgres Extensions in Rust">
  <meta name="twitter:description" content="Opening a new path to high-performance, domain-specific database applications.">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Depth-First
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Articles
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Postgres Extensions in Rust</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-08-25T15:00:00Z">August 25, 2021</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p><a href="https://www.postgresql.org">PostgreSQL</a> (aka &ldquo;Postgres&rdquo;) is a widely-used relational database system. One of the many features making it so popular is extensibility. Postgres <a href="https://www.postgresql.org/docs/13/contrib.html">ships with several extensions</a>, and others are <a href="https://pgxn.org">available from third parties</a>. Underpinning this large body of extended functionality is <a href="https://www.postgresql.org/docs/13/extend.html">a system</a> for building and deploying extensions.</p>
<p>For flexibility and performance, Postgres supports extensions <a href="https://www.postgresql.org/docs/13/xfunc-c.html">written in C</a>. More recently, and very quietly, Rust has become a first-class language for extension development. This article offers a short introduction to building Postgres extensions in Rust. No previous experience with Rust or Postgres is needed.</p>
<h1 id="prerequisites">Prerequisites</h1>
<p>Following the tutorial requires a Rust tool chain, which can be obtained as described at <a href="https://rustup.rs">Rustup</a>. Installation provides a Rust compiler and the <a href="https://doc.rust-lang.org/cargo/">Cargo</a> package manager.</p>
<h1 id="quickstart">Quickstart</h1>
<p>The following short tutorial was tested on macOS Mojave and Rust 1.52.1.</p>
<p>Begin by installing the <a href="https://github.com/zombodb/pgx">pgx crate</a>, a complete suite of tools for building Postgres extensions in Rust.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo install cargo-pgx
</span></span><span style="display:flex;"><span>cargo pgx init
</span></span></code></pre></div><p>The second command took about 30 minutes on my system. Packaged with the pgx crate are the last four major releases of Postgres, the source for each of which must be downloaded and compiled. These are installed into <code>~/.pgx</code>.</p>
<p>Create a new Postgres extension project as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo pgx new my_extension
</span></span><span style="display:flex;"><span>cd my_extension
</span></span></code></pre></div><p>pgx extends Cargo with a utility for initializing new projects, as done above. The new project so created contains a fully-functional Postgres extension, which can be compiled and tested.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo pgx run pg13
</span></span></code></pre></div><p>The second argument, <code>pg13</code> indicates that the extension will run on Postgres 13. Other options would be <code>pg12</code>, <code>pg11</code> and <code>pg10</code>.</p>
<p>After compilation (in my hands about 8 minutes), you&rsquo;ll be dropped into a <code>psql</code> shell. Test the extension by calling the <code>hello_my_extension</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> hello_my_extension() <span style="color:#66d9ef">AS</span> test;
</span></span><span style="display:flex;"><span><span style="color:#75715e">--         test         
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- ---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--  Hello, my_extension
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- (1 row)
</span></span></span></code></pre></div><h1 id="the-demo-project">The Demo Project</h1>
<p>The business-end of the extension is contained in the file <code>src/lib.rs</code>. It weighs in at all of six lines of code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> pgx::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pg_module_magic!();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[pg_extern]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello_my_extension</span>() -&gt; <span style="color:#66d9ef">&amp;</span>&#39;static <span style="color:#66d9ef">str</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Hello, my_extension&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Everything from this starting point on is pure Rust. pgx takes care of writing all bindings and all of the infrastructure needed to support an extension.</p>
<p>Two lines of the example are noteworthy. The first invokes the <code>pg_module_magic</code> function-like macro. Its purpose is to add a signature to the compiled binary designating it as a Postgres extension. The second noteworthy line invokes the <code>pg_extern</code> <a href="https://doc.rust-lang.org/reference/procedural-macros.html">derive macro</a>. This line designates the function as one that the extension will make visible when installed, automatically applying all of the additional code to make that happen. Like all derive macros, <code>pg_extern</code> accepts arguments (e.g.,  <code>name</code>,<code>immutable</code>, <code>schema</code>, and <code>parallel_safe</code>). These flags don&rsquo;t appear to be documented anywhere in the pgx project, but can be found in the <a href="https://github.com/zombodb/pgx/tree/master/pgx-examples">examples directory</a>.</p>
<p>Additional examples are available in <a href="https://github.com/zombodb/postgresconf">this repo</a>.</p>
<h1 id="why-extend-postgres">Why Extend Postgres?</h1>
<p>The current capabilities of Postgres and its available extensions set a very high bar for functionality. Still, there are a number of situations in which a custom extension is the best option.</p>
<p>For example, Postgres&rsquo;s native data types are unlikely to adequately capture many kinds of domain-specific data such as phone numbers and other identifiers, not to mention scientific data types such as <a href="/articles/2020/04/06/a-minimal-molecule-api/">molecules</a>. The inability to manipulate such data types within Postgres forces data manipulation tasks out of the database and into less appropriate places. The end result is data manipulation logic appearing within an application layer, or some other layer where it becomes an integration and maintenance burden. A well-designed extension makes it easy to transport domain-specific concerns with the database.</p>
<p>Another reason to extend Postgres is to support more complex functionality. With a few exceptions, pgx makes it possible to do anything inside of Postgres that is possible within Rust. The vast and rapidly-growing collection of <a href="https://crates.io">Rust crates</a> is open for use. Likewise, pgx supports most of the Postgres extension API. For example, pgx supports <a href="https://www.postgresql.org/docs/9.4/spi.html">the Server Programming Interface</a> (SPI). This interface allows extensions to run SQL queries (procedures) inside of custom functions.</p>
<h1 id="why-rust">Why Rust?</h1>
<p>High performance Postgres extensions have for the most part been written in C. Given that tradition, why start writing them in Rust with pgx? Reasons include:</p>
<ul>
<li><strong>Streamlined workflow.</strong> pgx writes all of the boilerplate code that would otherwise be needed to get an extension running in C.</li>
<li><strong>Minimize exposure to Postgres internals.</strong> As the example shows, it&rsquo;s now possible to write fully-functional extension without much knowledge of how Postgres works.</li>
<li><strong>Maximize exposure to Postgres internals.</strong> Although functionality is hidden behind some nice abstractions, these can be bypassed.</li>
<li><strong>Access Postgres native types and functions.</strong> Tight integration like this makes it possible to seamlessly blend Postgres with new functionality.</li>
<li><strong>Memory safety.</strong> This is Rust&rsquo;s best-known feature, and now it&rsquo;s possible to write Postgres extensions that make guarantees about memory safety.</li>
<li><strong>Low-level performance, high-level feel.</strong> Many developers who come to Rust for performance are surprised to find how usable the language is.</li>
</ul>
<h1 id="more-information">More Information</h1>
<p>The creator of pgx, <a href="https://github.com/eeeebbbbrrrr">Eric Ridge</a>, recently presented on pgx. The talk highlights some of the material covered here, and describes some other examples in depth.</p>
<!-- raw HTML omitted -->
<h1 id="other-projects">Other Projects</h1>
<p>Several other projects enabling the creation Postgres extensions in Rust have been started. Although none appear to be as complete as pgx, they illustrate different approaches to Rust/Postgres integration:</p>
<ul>
<li><a href="https://github.com/bluejekyll/pg-extend-rs">pg-extend-rs</a>. Also uses Cargo macros.</li>
<li><a href="https://github.com/posix4e/rpgffi">rpgffi</a>. The state of this project isn&rsquo;t clear from the documentation.</li>
<li><a href="https://github.com/jeff-davis/postgres-extension.rs">postgres-extension.rs</a>. No written documentation is available, but the author <a href="https://www.youtube.com/watch?v=7Ra5QO3Cxj4">presented</a> the work and the <a href="https://www.pgcon.org/2019/schedule/attachments/532_RustTalk.pdf">slide deck</a> offers some insights into why Rust should be considered for Postgres extensions.</li>
<li><a href="https://github.com/wasmerio/wasmer-postgres">Wasmer Postgres</a>. Last but not least, it may be possible to compile Rust to WebAssembly, then use the result as an extension. The <a href="https://github.com/wasmerio/wasmer-postgres/tree/master/examples">examples</a> directory contains an example.</li>
</ul>
<h1 id="conclusion">Conclusion</h1>
<p>The pgx crate offers a full suite of powerful tools for creating Postgres extensions in Rust. Custom functions, custom data types, and tight integration with Postgres are all supported. The author has created several examples, some of which were described in detail in a recent talk. Although other projects aim to provide similar functionality, I&rsquo;m aware of no other project with the breadth or depth of support currently offered by pgx.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  Depth-First 2024 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
