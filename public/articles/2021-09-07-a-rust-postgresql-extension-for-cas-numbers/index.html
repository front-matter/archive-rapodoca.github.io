<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>A Rust PostgreSQL Extension for CAS Numbers | Depth-First</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Making domain-specific types first-class citizens in one of the most popular database systems.">
    <meta name="generator" content="Hugo 0.139.4">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    
      <meta name="author" content = "Richard L. Apodaca">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="https://depth-first.com:1313/articles/2021-09-07-a-rust-postgresql-extension-for-cas-numbers/">
    

    <meta property="og:url" content="https://depth-first.com:1313/articles/2021-09-07-a-rust-postgresql-extension-for-cas-numbers/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="A Rust PostgreSQL Extension for CAS Numbers">
  <meta property="og:description" content="Making domain-specific types first-class citizens in one of the most popular database systems.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="articles">
    <meta property="article:published_time" content="2021-09-07T15:00:00+00:00">
    <meta property="article:modified_time" content="2021-09-07T15:00:00+00:00">

  <meta itemprop="name" content="A Rust PostgreSQL Extension for CAS Numbers">
  <meta itemprop="description" content="Making domain-specific types first-class citizens in one of the most popular database systems.">
  <meta itemprop="datePublished" content="2021-09-07T15:00:00+00:00">
  <meta itemprop="dateModified" content="2021-09-07T15:00:00+00:00">
  <meta itemprop="wordCount" content="1351">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="A Rust PostgreSQL Extension for CAS Numbers">
  <meta name="twitter:description" content="Making domain-specific types first-class citizens in one of the most popular database systems.">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Depth-First
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Articles
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">A Rust PostgreSQL Extension for CAS Numbers</h1>
      
      <p class="tracked">
        By <strong>Richard L. Apodaca</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-09-07T15:00:00Z">September 7, 2021</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>The <a href="/articles/2021/08/25/postgres-extensions-in-rust/">previous article</a> in this series introduced a simple method for writing PostgreSQL extensions in Rust with the <a href="https://github.com/zombodb/pgx">pgx crate</a>. The example in that article, although a complete extension, only exposed a function. A more interesting extension would define a custom data type that worked correctly with indexes. This article describes such an extension.</p>
<h1 id="compiling-and-running-the-extension">Compiling and Running the Extension</h1>
<p>The extension, <a href="https://github.com/rapodaca/cas_number">cas_number</a> is available on GitHub. Assuming <a href="/articles/2021/08/25/postgres-extensions-in-rust/">the dependencies</a> are in place, compile as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo pgx run pg13
</span></span></code></pre></div><p>pgs starts a Postgres client after compiling the extension. Install it in the usual way.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> EXTENSION <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span> cas_number <span style="color:#66d9ef">cascade</span>; <span style="color:#75715e">-- allows re-installation later
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> EXTENSION cas_number; <span style="color:#75715e">-- create the extension
</span></span></span></code></pre></div><p>Having created the extension, we can work with CAS Numbers as if the type were native to Postgres. For example, we can create a table containing CAS Numbers like so.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> cas_numbers (id int, cas_number casnumber);
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- CREATE TABLE
</span></span></span></code></pre></div><p>Here, the type <code>casnumber</code> was defined by the <code>cas_number</code> extension. Postgres respects the restrictions on this data type just like it would with <code>string</code> or <code>int</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> cas_numbers (id, cas_number)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VALUES</span> (<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;111-11-1&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ERROR:  invalid CAS Number
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- ...
</span></span></span></code></pre></div><p>The table can be populated with 100,000 random CAS Numbers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> cas_numbers
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> generate_series(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">100000</span>) <span style="color:#66d9ef">as</span> id,
</span></span><span style="display:flex;"><span>       random_cas_number();
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- INSERT 0 100000
</span></span></span></code></pre></div><p>Queries on tables this large without indexes often perform poorly, which can be easily verified here. The problem can be overcome with an index on the <code>cas_number</code> field.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> cas_numbers_cas_number <span style="color:#66d9ef">on</span> cas_numbers (cas_number);
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- CREATE INDEX
</span></span></span></code></pre></div><p>Now Postgres will use the index rather than the default sequential scan strategy for many kinds of queries.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">EXPLAIN</span> <span style="color:#66d9ef">ANALYZE</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span>   id, cas_number
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span>     cas_numbers
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span>    cas_number <span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#39;67-64-1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> cas_number
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LIMIT</span>    <span style="color:#ae81ff">25</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">--                                                                     QUERY PLAN                                                                     
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- ---------------------------------------------------------------------------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--  Limit  (cost=0.42..3.04 rows=25 width=36) (actual time=0.791..0.822 rows=25 loops=1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--    -&gt;  Index Scan using cas_numbers_cas_number on cas_numbers  (cost=0.42..3499.74 rows=33333 width=36) (actual time=0.790..0.817 rows=25 loops=1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--          Index Cond: (cas_number &gt; &#39;67-64-1&#39;::casnumber)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--  Planning Time: 0.356 ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--  Execution Time: 0.900 ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- (5 rows)
</span></span></span></code></pre></div><h1 id="cas-numbers-and-their-validation">CAS Numbers and Their Validation</h1>
<p>The extension defines a custom data type, <code>casnumber</code>, that models a <a href="https://www.cas.org/cas-data/cas-registry">Chemical Abstracts Service Registry Number</a>Â® (aka &ldquo;CAS Number&rdquo;). A CAS Number is a unique identifier for chemical substances managed by the <a href="https://www.acs.org">American Chemical Society</a>. CAS Numbers look vaguely like phone numbers, but work quite differently.</p>
<p>A CAS number is a string composed of three groups of digit characters (<code>0</code>-<code>9</code>) separated by the dash character (<code>-</code>). For example, the CAS Number for water is <code>7732-18-5</code>. The leftmost group of characters, which I call the &ldquo;base,&rdquo; contains between two and seven digits. A leading zero is not allowed, but there are no other restrictions. The middle group contains two digits, which I call the &ldquo;suffix.&rdquo; The rightmost group contains a single &ldquo;check&rdquo; digit.</p>
<p>The following regular expression can be used to validate CAS Numbers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>^[1-9]\d{1,6}-\d{2}-\d$
</span></span></code></pre></div><p>The purpose of the check digit is to prevent data entry errors. It is computed as follows. Read all digits, excluding the check digit, sequentially from right-to-left. Assign the first digit an index <code>i</code> of 1, the next an index <code>i</code> 2, and so on. A checksum <code>c</code> is computed by the summation:</p>
<pre tabindex="0"><code class="language-asciimath" data-lang="asciimath">c = sum_(i=1)^n i*V_i
</code></pre><p>where <code>i</code> is the one-based, right-to-left index of the digit and <del>V_i</del> is the value of the digit at index <code>i</code>.</p>
<p>The check digit is then computed as the modulo-10 remainder of <code>c</code>.</p>
<p>For example, <a href="https://en.wikipedia.org/wiki/Paclitaxel">paclitaxel</a> (&ldquo;Taxol&rdquo;) has the CAS Number <code>33069-62-4</code>. The check digit is 4, which can be computed as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>(2*1 + 6*2 + 9*3 + 6*4 + 0*5 + 3*6 + 3*7) % 10 = 4
</span></span></code></pre></div><p>The Postgres extension performs this check during the translation of <code>string</code> instances.</p>
<h1 id="overview-of-the-extension">Overview of the Extension</h1>
<p>The extension itself is comprised of just two Rust source files: <code>lib.rs</code> and <code>cas_number.rs</code>. The former file just brings the latter into scope and invokes the macro responsible for embedding the Postgres extension signature.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// lib.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">use</span> pgx::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> cas_number;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pg_module_magic!();
</span></span></code></pre></div><p>The file <code>cas_number.rs</code> defines the custom Postgres type and an exported helper function. The type is just an annotated Rust <code>struct</code> following the <a href="https://doc.rust-lang.org/rust-by-example/generics/new_types.html">newtype</a> pattern:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// ... macro invocations
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">CasNumber</span>(String);
</span></span></code></pre></div><p><code>CasNumber</code> contains a private field of type <code>String</code>. This pattern makes it possible to apply various macros and function definitions to <code>CasNumber</code>, including those required by pgx. pgx automatically translates the Rust symbol <code>CasNumber</code> to <code>casnumber</code> in Postgres sessions.</p>
<h1 id="cas-number-validation-in-rust">CAS Number Validation in Rust</h1>
<p>The business end of the extension is the <code>validate</code> function, which returns <code>true</code> given a valid CAS Number <code>str</code> encoding or <code>false</code> otherwise.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// cas_number.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">validate</span>(id: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> re <span style="color:#f92672">=</span> Regex::new(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;^([1-9])(\d{1,6})-(\d{2})-(\d)$&#34;</span>).unwrap();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> caps <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> re.captures(id) {
</span></span><span style="display:flex;"><span>        Some(caps) <span style="color:#f92672">=&gt;</span> caps,
</span></span><span style="display:flex;"><span>        None <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> digits <span style="color:#f92672">=</span> format!(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}{}{}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        caps.get(<span style="color:#ae81ff">1</span>).unwrap().as_str(),
</span></span><span style="display:flex;"><span>        caps.get(<span style="color:#ae81ff">2</span>).unwrap().as_str(),
</span></span><span style="display:flex;"><span>        caps.get(<span style="color:#ae81ff">3</span>).unwrap().as_str()
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> checksum <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (n, digit) <span style="color:#66d9ef">in</span> digits.chars().rev().enumerate() {
</span></span><span style="display:flex;"><span>        checksum <span style="color:#f92672">+=</span> (n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u32</span> <span style="color:#f92672">*</span> digit.to_digit(<span style="color:#ae81ff">10</span>).unwrap();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    checksum <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">==</span> caps.get(<span style="color:#ae81ff">4</span>).unwrap().as_str().parse::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span><span style="color:#f92672">&gt;</span>().unwrap()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="generating-random-cas-numbers-in-rust">Generating Random CAS Numbers in Rust</h1>
<p>Also included with the extension is the <code>random_cas_number</code> function, which generates valid <code>CasNumber</code> instances. It can be used to build large tables containing columns of type <code>casnumber</code> for mockups and performance testing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// cas_number.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">random_cas_number</span>() -&gt; <span style="color:#a6e22e">CasNumber</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> base <span style="color:#f92672">=</span> rand::thread_rng().gen_range(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">9</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> digits <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> checksum: <span style="color:#66d9ef">u32</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>(base <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> digit <span style="color:#f92672">=</span> random_digit(i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        checksum <span style="color:#f92672">+=</span> (base <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u32</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> i <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u32</span>) <span style="color:#f92672">*</span> digit <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u32</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        digits.push(digit)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> string <span style="color:#f92672">=</span> String::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i, digit) <span style="color:#66d9ef">in</span> digits.into_iter().enumerate() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> base <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>            string.push_str(<span style="color:#e6db74">&#34;-&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        string.push_str(<span style="color:#f92672">&amp;</span>digit.to_string())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    CasNumber(format!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">-</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, string, checksum <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">random_digit</span>(exclude_zero: <span style="color:#66d9ef">bool</span>) -&gt; <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> exclude_zero {
</span></span><span style="display:flex;"><span>        rand::thread_rng().gen_range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">9</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        rand::thread_rng().gen_range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">9</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="why">Why?</h1>
<p>The utility of Postgres extensions like the one described here may not be apparent at first (or second) glance. The primary purpose is to enable Postgres to ensure that custom data types are properly validated before use - just like any other native type. A secondary purpose is to offload domain-specific data management tasks to Postgres that would otherwise take place elsewhere, such as in an application layer. In many situations, it makes sense to keep data manipulation and validation logic within the database itself and within transactional boundaries.</p>
<p>This isn&rsquo;t necessarily an either-or proposition. For example, form validation in Web applications typically occurs in three different places: on the form itself using HTML controls; in the server application layer; and in the database. Each stage of validation serves a different purpose. Postgres extensions such as the one described here make it possible to extend boundary checking patterns commonly used for primitives such as decimals and integers to custom data types like CAS Numbers.</p>
<p>Of course Postgres can be (and often is) used without an application layer at all. In these cases, Postgres is responsible for all data validation. Extensions like the one described here make it possible to use Postgres as if it had native support for domain-specific data types.</p>
<p>Either way, writing Postgres extensions in Rust using pgx brings important benefits. As you can see, most of the work of generating the extension is done by pgx. That leaves the developer with only the task of writing the domain-specific code to control the extension. Given that the language is Rust, all of its features such as high performance, high-level ergonomics, the Cargo package manager, and type safety are at your fingertips.</p>
<h1 id="other-work">Other Work</h1>
<p>The extensions described here is based on a demo extension for phone numbers contained in <a href="https://github.com/zombodb/postgresconf">this repository</a>. In addition to replacing phone numbers for CAS Numbers, my example simplifies the project layout, localizing plugin and validation logic in one file and eliminating other functionality to highlight extension points.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Extensions make it possible to work with domain-specific data types as if they were native to Postgres. This article describes a non-trivial Postgres extension with both a custom function and a custom data type that works well with indexes. The <a href="https://github.com/rapodaca/cas_number">project repository</a> can serve as a template for a variety of high-performance extensions supporting domain-specific types and functions.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://depth-first.com:1313/" >
    &copy;  Depth-First 2024 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
