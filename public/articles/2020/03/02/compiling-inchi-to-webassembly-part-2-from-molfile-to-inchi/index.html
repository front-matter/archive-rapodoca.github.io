<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Compiling InChI to WebAssembly Part 2: From Molfile to InChI | Depth-First</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="A comprehensive tutorial with working demos.">
    <meta name="generator" content="Hugo 0.139.4">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/articles/2020/03/02/compiling-inchi-to-webassembly-part-2-from-molfile-to-inchi/">
    

    <meta property="og:url" content="http://localhost:1313/articles/2020/03/02/compiling-inchi-to-webassembly-part-2-from-molfile-to-inchi/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="Compiling InChI to WebAssembly Part 2: From Molfile to InChI">
  <meta property="og:description" content="A comprehensive tutorial with working demos.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="articles">
    <meta property="article:published_time" content="2020-03-02T14:00:00+00:00">
    <meta property="article:modified_time" content="2020-03-02T14:00:00+00:00">

  <meta itemprop="name" content="Compiling InChI to WebAssembly Part 2: From Molfile to InChI">
  <meta itemprop="description" content="A comprehensive tutorial with working demos.">
  <meta itemprop="datePublished" content="2020-03-02T14:00:00+00:00">
  <meta itemprop="dateModified" content="2020-03-02T14:00:00+00:00">
  <meta itemprop="wordCount" content="1984">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Compiling InChI to WebAssembly Part 2: From Molfile to InChI">
  <meta name="twitter:description" content="A comprehensive tutorial with working demos.">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Depth-First
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Articles
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Compiling InChI to WebAssembly Part 2: From Molfile to InChI</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-03-02T14:00:00Z">March 2, 2020</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p><a href="https://iupac.org/who-we-are/divisions/division-details/inchi/">InChI</a> is a software package that generates unique chemical identifiers. Although InChI&rsquo;s C source yields executables for many platforms, there are exceptions. For a long time, the Web browser was one of them. A few years ago, I showed how to compile <a href="https://metamolecular.com/inchi-js/">InChI to JavaScript</a>. That solution works, but recent developments, both in browsers and InChI itself, suggest a better approach is possible.</p>
<p>More recently, I described a procedure for <a href="/articles/2019/05/15/compiling-inchi-to-webassembly-part-1/">compiling the InChI main function to WebAssembly (aka Wasm)</a>. The result wasn&rsquo;t very useful because it just printed command line options and immediately exited. What&rsquo;s needed is a robust method for compiling useful InChI libraries to WebAssembly, which can then be exposed through thin JavaScript wrappers.</p>
<p>This article takes the next step by describing how to compile the InChI C source to Wasm, and then link the result through a concise, manually generated JavaScript wrapper. Only an LLVM toolchain is required. Unlike the previous article in this series, Emscripten is neither needed nor used. Beyond solving the specific problem of using InChI, what follows could be considered a blueprint for deploying any C code base to a Web browser.</p>
<h1 id="quickstart">Quickstart</h1>
<p>Before describing the solution at a technical level, those who are only interested in testing the InChI-Wasm functionality can do so on the <a href="https://metamolecular.com/inchi-wasm">InChI-Wasm page</a>. GitHub hosts a <a href="https://github.com/rapodaca/inchi-wasm">source code repository</a>.</p>
<h1 id="compilation">Compilation</h1>
<p>Compilation to Wasm follows the <a href="/articles/2019/10/16/compiling-c-to-webassembly-and-running-it-without-emscripten/">previously-described system</a>. To recap:</p>
<ol>
<li>Install LLVM on your platform. On macOS, that probably means installing through Homebrew.</li>
<li>Activate LLVM, if necessary. macOS users will need to append the LLVM <code>bin</code> path to the <code>PATH</code> environment variable. Something like <code>export PATH=/usr/local/opt/llvm/bin:$PATH</code> should work.</li>
<li>Verify that LLVM is working with <code>llc --version</code>. The output should include <code>wasm32</code> and <code>wasm64</code>.</li>
<li>Clone, compile, and install <a href="https://github.com/CraneStation/wasi-libc">wasi-libc</a>.</li>
<li>Copy the file <a href="https://github.com/jedisct1/libclang_rt.builtins-wasm32.a">libclang_rt.builtins-wasm32.a</a> to your local LLVM <code>bin/wasi</code> directory.</li>
</ol>
<p>With these prerequisites out of the way, InChI-Wasm can be compiled. Clone <a href="https://github.com/rapodaca/inchi-wasm">the source</a>, change into the repo directory, then initialize the inchi submodule.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>git clone https://github.com/rapodaca/inchi-wasm
</span></span><span style="display:flex;"><span>cd inchi-wasm
</span></span><span style="display:flex;"><span>git submodule init
</span></span><span style="display:flex;"><span>git submodule update
</span></span></code></pre></div><p>Next, export the location of your <code>wasi-libc</code> installation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>export WASI_LIBC_HOME=/path/to/wasi-libc
</span></span></code></pre></div><p>Finally, compile InChI-Wasm with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>bin/build.sh
</span></span></code></pre></div><p>Running this script places the compiled <code>.wasm</code> file into the <code>build</code> directory.</p>
<h1 id="technical-overview">Technical Overview</h1>
<p>The main advantage of the approach described here over others is simplicity. A stock LLVM 9.0 installation and some libraries are all that&rsquo;s needed. In this respect, the method closely resembles that for compilation of a native binary. Recent updates to LLVM made this new approach feasible.</p>
<p>The structure of the <a href="https://github.com/rapodaca/inchi-wasm"><code>inchi-wasm</code></a> repository will likely reflect the structure of any project whose aim is to compile C source to Wasm:</p>
<ol>
<li><code>lib/wasi.js</code> A static JavaScript support file borrowed from <a href="https://github.com/wasmerio/wasmer-js">wasmer-js project</a>.</li>
<li><code>lib/molfile-to-inchi.js</code> A custom JavaScript bootstrap file that loads the <code>.wasm</code> file and defines a wrapper function.</li>
<li><code>src/molfile_to_inchi.c</code> A hand-coded wrapper function that converts a molfile string into an InChI string.</li>
<li><code>web/index.html</code> Invokes <code>molfile-to-inchi.js</code> and builds a test harness.</li>
<li><code>bin/build.sh</code> A build script that compiles and links <code>molfile_to_inchi.c</code> using LLVM.</li>
<li><code>inchi</code> git submodule. The unaltered InChI C source files <a href="https://github.com/metamolecular/inchi">hosted on GitHub</a>.</li>
</ol>
<h1 id="srcmolfile_to_inchic"><code>src/molfile_to_inchi.c</code></h1>
<p>At the core of InChI-Wasm sits sits the function <code>molfile_to_inchi</code>, which is contained in the file <code>molfile_to_inchi.c</code>. Thanks to the addition of the <code>MakeINCHIFromMolfileText</code> function to the latest InChI revision, the requirements for the wrapper function were minimal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;time.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;inchi_api.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">size_t</span> <span style="color:#a6e22e">molfile_to_inchi</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>molfile, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>options, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>result)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    inchi_Output output;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> status <span style="color:#f92672">=</span> <span style="color:#a6e22e">MakeINCHIFromMolfileText</span>(molfile, options, <span style="color:#f92672">&amp;</span>output);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> status <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strcpy</span>(result, output.szInChI);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strcpy</span>(result, output.szMessage); <span style="color:#75715e">// this should work but doesn&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FreeINCHI</span>(<span style="color:#f92672">&amp;</span>output);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// see:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// https://stackoverflow.com/questions/31476632/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// https://stackoverflow.com/a/617606/54426
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">clock_t</span> <span style="color:#a6e22e">__wrap_clock</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>molfile_to_inchi</code> function accepts three parameters representing buffers for the input molfile, InChI options, and the InChI result. Invocation of the <code>MakeINCHIFromMolfileText</code> is followed by <code>strcpy</code> to set the output buffer with the result. After freeing a temporary data structure, an integer status code is returned.</p>
<p>The InChI documentation implies that <code>MakeINCHIFromMolfileText</code> places error messages into the <code>szMessage</code> field of the <code>inchi_Output</code> struct. This technique was previously used to compile InChI to Javascript. However, I have not been able to get such error reporting to work in the current iteration.</p>
<p>I&rsquo;ll have more to say about the second function, <code>__wrap_clock</code>, later.</p>
<h1 id="libmolfile-to-inchijs"><code>lib/molfile-to-inchi.js</code></h1>
<p>The C function has a counterpart written in JavaScript and hosted at <code>lib/molfile-to-inchi.js</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">WASI</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./wasi.esm.js&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmPath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;../build/molfile_to_inchi.wasm&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">memory</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Memory</span>({ <span style="color:#a6e22e">initial</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">wasmPath</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bytes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">arrayBuffer</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasi</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WASI</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">instance</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiate</span>(<span style="color:#a6e22e">bytes</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">env</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">memory</span> }, <span style="color:#a6e22e">wasi_snapshot_preview1</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">wasi</span>.<span style="color:#a6e22e">wasiImport</span>
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pMolfile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">1024</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pOptions</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">1024</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pOutput</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">20480</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  window.<span style="color:#a6e22e">molfileToInChI</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">molfile</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">inputView</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">encoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextEncoder</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">inputView</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">molfile</span>), <span style="color:#a6e22e">pMolfile</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">molfile_to_inchi</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pMolfile</span>, <span style="color:#a6e22e">pOptions</span>, <span style="color:#a6e22e">pOutput</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">outputView</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">decoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextDecoder</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">output</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">decode</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">outputView</span>.<span style="color:#a6e22e">subarray</span>(<span style="color:#a6e22e">pOutput</span>, <span style="color:#a6e22e">outputView</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">pOutput</span>))
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">result</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> Error(<span style="color:#e6db74">&#34;inchi error: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">output</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">output</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  window.<span style="color:#a6e22e">dispatchEvent</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Event</span>(<span style="color:#e6db74">&#39;InChIReady&#39;</span>));
</span></span><span style="display:flex;"><span>})();
</span></span></code></pre></div><p>The file begins by importing <code>WASI</code> from the <code>wasi.esm.js</code> file. Doing so enables the instantiation of an object with the <code>wasiImport</code> property. This property is used to create the WebAssembly <code>instance</code>.</p>
<p>The main block uses the asynchronous IIFE pattern <a href="/articles/2019/10/16/compiling-c-to-webassembly-and-running-it-without-emscripten/">discussed previously</a>. Briefly, async/await functionality must be wrapped in a function using the <code>async</code> keyword. The asynchronous IIFE pattern is a convenient way to take advantage of async/await operations.</p>
<p>Three memory allocations are made using the Wasm instance&rsquo;s <code>malloc</code> function. Each call returns a pointer into <a href="https://webassembly.org/docs/semantics/#linear-memory">linear memory</a>. The pointers are passed into the instance&rsquo;s <code>molfile_to_inchi</code> function. The result is an integer response code that can be used for reporting.</p>
<p>If no error codes are returned, the string representation of the buffer holding the InChI is returned.</p>
<p>The penultimate line dispatches a custom <code>InChIReady</code> event signaling that the global <code>molfileToInChI</code> function can be used. Attempts to access the function before the event is fired will result in an error.</p>
<h1 id="binbuildsh">bin/build.sh</h1>
<p>The script located at <code>bin/build.sh</code> orchestrates the compilation of <code>molfile_from_inchi.c</code> and the InChI source files. Two checks take place before compilation. First, the build script requires that the environment variable <code>WASI_LIBC_HOME</code> be set, or an error will result. Second, the operating system is checked. If macOS is detected, the InChI-specific flag <code>__APPLE__</code>, is set as <a href="/2019/05/15/compiling-inchi-to-webassembly-part-1/">previously described</a>. After making these checks, a build directory is created if necessary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$WASI_LIBC_HOME<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Reading libc from </span>$WASI_LIBC_HOME<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Set the libc location with &#39;export WASI_LIBC_HOME=path/to/wasi-libc&#39;.&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$OSTYPE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span>~ ^darwin <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  PLATFORM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-D__APPLE__&#34;</span>
</span></span><span style="display:flex;"><span>  PATH<span style="color:#f92672">=</span>/usr/local/opt/llvm/bin:$PATH
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  PLATFORM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clang <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --target<span style="color:#f92672">=</span>wasm32-unknown-wasi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --sysroot <span style="color:#e6db74">${</span>WASI_LIBC_HOME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Oz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-import-memory <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-wrap,clock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-export,malloc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-export,molfile_to_inchi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-no-entry <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -DTARGET_API_LIB <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">${</span>PLATFORM<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Iinchi/INCHI_BASE/src <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  inchi/INCHI_BASE/src/*.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  inchi/INCHI_API/libinchi/src/*.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  src/molfile_to_inchi.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -o build/molfile_to_inchi.wasm
</span></span></code></pre></div><p>With all checks performed and a <code>build</code> directory in place, the build script invokes <code>clang</code>. Options are explained as follows:</p>
<ul>
<li><code>--target=wasm32-unknown-wasi</code>. Directs compilation using the <a href="https://hacks.mozilla.org/2019/03/standardizing-wasi-a-webassembly-system-interface/">WebAssembly System Interface</a>.</li>
<li><code>--sysroot ${WASI_LIBC_HOME}</code>. Replaces the standard library with wasi-libc.</li>
<li><code>-Oz</code>. Aggressive optimization.</li>
<li><code>-v</code> Verbose output.</li>
<li><code>-Wl,-import-memory</code>. Require that the Wasm instance be supplied with <code>WebAssembly.Memory</code> instance.</li>
<li><code>-Wl,-wrap,clock</code>. Wraps the <code>clock</code> standard library function, for reasons described below. Note the single dash (<code>-</code>).</li>
<li><code>-Wl,-export,malloc</code>. Make <code>malloc</code> available to the Wasm instance.</li>
<li><code>-Wl,-export,molfile_to_inchi</code>. Make <code>molfile_to_inchi</code> available to the Wasm instance.</li>
<li><code>-Wl,-no-entry</code>. Don&rsquo;t check for a <code>main</code> function.</li>
<li><code>-DTARGET_API_LIB</code>. One of four settings required by InChI.</li>
<li><code>${PLATFORM}</code>. Optionally includes the <code>-D__APPLE__</code> InChI flag.</li>
<li><code>-Iinchi/INCHI_BASE/src</code>. Path to search for InChI headers.</li>
<li><code>inchi/INCHI_BASE/src/*.c</code>. One path to InChI source files.</li>
<li><code>inchi/INCHI_API/libinchi/src/*.c</code>. Another path to InChI source files.</li>
<li><code>src/molfile_to_inchi.c</code>. Path to the file containing the wrapper function.</li>
<li><code>-o build/molfile_to_inchi.wasm</code>. The path to the compiled wasm file.</li>
</ul>
<p>Deleting the <code>-Wl,-wrap,clock</code> option will result in a JavaScript runtime error. Depending on your browser, you may see:</p>
<ul>
<li>Safari. <code>TypeError: i64 not allowed as return type or argument to an imported function</code></li>
<li>Firefox. <code>TypeError: cannot pass i64 to or from JS</code></li>
<li>Chrome. <code>Uncaught TypeError: wasm function signature contains illegal type</code></li>
</ul>
<p>These errors <a href="https://github.com/unoplatform/Uno.Wasm.Bootstrap/issues/128">appear</a> to trace back to the current <a href="https://webassembly.org/docs/c-and-c++/">lack of support for 64-bit types</a> in browser-based Wasm implementations. The situation will eventually be corrected, but for now calls dealing with 64-bit types such as <code>clock</code> and <code>times</code> will require workarounds.</p>
<p>The <code>wrap</code> option lets us override the <code>clock</code> function - without touching the InChI code base. The tradeoff is that all of the code relying on time will be rendered inoperable. This doesn&rsquo;t affect InChI, at least not the way it&rsquo;s accessed in this article. However, other applications of InChI or other code bases may require more or less work to get past the 64-bit issue on browsers.</p>
<h1 id="indexhtml">index.html</h1>
<p>The HTML file located at <code>web/index.html</code> invokes the <code>molfile-to-inchi.js</code> script and sets up the test harness. Note the presence of the <code>type=&quot;module&quot;</code> attribute on the <code>&lt;script&gt;</code> tag, which is required.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;InChI WASM Test&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../lib/molfile-to-inchi.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">style</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">label</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-size</span>: <span style="color:#ae81ff">120</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-weight</span>: <span style="color:#66d9ef">bold</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">padding-bottom</span>: <span style="color:#ae81ff">1</span><span style="color:#66d9ef">em</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      #molfile {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">width</span>: <span style="color:#ae81ff">100</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">height</span>: <span style="color:#ae81ff">400</span><span style="color:#66d9ef">px</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-size</span>: <span style="color:#ae81ff">120</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-family</span>: <span style="color:#66d9ef">monospace</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">margin-bottom</span>: <span style="color:#ae81ff">1</span><span style="color:#66d9ef">em</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      #inchi {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">width</span>: <span style="color:#ae81ff">100</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">height</span>: <span style="color:#ae81ff">1.5</span><span style="color:#66d9ef">em</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-size</span>: <span style="color:#ae81ff">120</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-family</span>: <span style="color:#66d9ef">monospace</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">style</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;molfile&#34;</span>&gt;Molfile:&lt;/<span style="color:#f92672">label</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">textarea</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;molfile&#34;</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   CWRITER02282009502D
</span></span><span style="display:flex;"><span>Created with ChemWriter - https://chemwriter.com
</span></span><span style="display:flex;"><span>  6  6  0  0  0  0  0  0  0  0999 V2000
</span></span><span style="display:flex;"><span>   75.8435  -39.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   84.5038  -44.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   93.1640  -39.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   93.1640  -29.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   84.5038  -24.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   75.8435  -29.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>  1  2  2  0  0  0  0
</span></span><span style="display:flex;"><span>  2  3  1  0  0  0  0
</span></span><span style="display:flex;"><span>  3  4  2  0  0  0  0
</span></span><span style="display:flex;"><span>  4  5  1  0  0  0  0
</span></span><span style="display:flex;"><span>  5  6  2  0  0  0  0
</span></span><span style="display:flex;"><span>  6  1  1  0  0  0  0
</span></span><span style="display:flex;"><span>M  END&lt;/<span style="color:#f92672">textarea</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inchi&#34;</span>&gt;InChI:&lt;/<span style="color:#f92672">label</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">textarea</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inchi&#34;</span>&gt;&lt;/<span style="color:#f92672">textarea</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">update</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">molfile</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">molfileToInChI</span>(<span style="color:#a6e22e">molfile</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>          document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#inchi&#39;</span>).<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ERROR&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#inchi&#39;</span>).<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;InChIReady&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">molfile</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#molfile&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">molfile</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">molfile</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;input&#39;</span>, (<span style="color:#a6e22e">e</span>) =&gt; {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">molfile</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>After setting up some styles and script invocations in the <code>&lt;head&gt;</code> element, the HTML file defines two text areas - one for molfile input and the other for InChI output. a <code>&lt;script&gt;</code> coordinates the interaction between the two, invoking the <code>molfileToInChI</code> function as needed.</p>
<h1 id="wasijs">wasi.js</h1>
<p>The file at <code>lib/wasi.esm.js</code> was copied verbatim from the  <a href="https://github.com/wasmerio/wasmer-js">wasmer-js project</a>. This file never needs to be changed and so can be used in any Wasm build. Projects not using the Standard C library do not need this file, but should make adjustments to the instantiation of the Wasm instance.</p>
<h1 id="inchi-submodule">inchi submodule</h1>
<p>The InChI source code is installed as a <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">Git submodule</a> from <a href="https://github.com/metamolecular/inchi">an unofficial InChI GitHub repository</a>.</p>
<p>This method ensures that InChI-Wasm can continue to be compiled as updates to the InChI C source package are made.</p>
<h1 id="conclusion">Conclusion</h1>
<p>This article describes the first successful compilation of a molfile to InChI function from C to WebAssembly. The underlying library is a non-trivial code base written in C, none of whose files files were modified. This was accomplished using a stock LLVM installation and some support libraries. Emscripten was not used. Supporting files used in this project are compact and follow up-to-date practices.</p>
<p>The same approach outlined here could be applied to any cheminformatics or computational chemistry package written in C or C++. The recent arrival of the LLVM-based <a href="https://github.com/flang-compiler/f18">F18 compiler</a> may even enable the compilation of older computational chemistry packages written in Fortran to WebAssembly.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  Depth-First 2024 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
