<!DOCTYPE html>
<html lang="en-us" dir="ltr" class="scroll-smooth" data-default-appearance="light"
  data-auto-appearance="true"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en-us" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Compiling InChI to WebAssembly Part 2: From Molfile to InChI &middot; Depth-First</title>
  <meta name="title" content="Compiling InChI to WebAssembly Part 2: From Molfile to InChI &middot; Depth-First" />
  
  <meta name="description" content="A comprehensive tutorial with working demos." />
  
  
  
  <link rel="canonical" href="http://localhost:1313/articles/2020/03/02/compiling-inchi-to-webassembly-part-2-from-molfile-to-inchi/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.e27868ab1485f7ed7b06b122b4980bd38b19526eb8f7de885181204d28f04a0c47e9c334eff19a06c0278eb2ff8415b983a5d0fb80fd6b5680c926457cc61c57.css"
    integrity="sha512-4nhoqxSF9&#43;17BrEitJgL04sZUm64996IUYEgTSjwSgxH6cM07/GaBsAnjrL/hBW5g6XQ&#43;4D9a1aAySZFfMYcVw==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.c178288131a2f1ad46910438db47ac5f7e1c48cf949e49f6dc3310c8ec9660e23fe505805eba4e2e73711335808500360d773a2b64322feb35df52856edca286.js"
    integrity="sha512-wXgogTGi8a1GkQQ420esX34cSM&#43;Unkn23DMQyOyWYOI/5QWAXrpOLnNxEzWAhQA2DXc6K2QyL&#43;s131KFbtyihg==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="http://localhost:1313/articles/2020/03/02/compiling-inchi-to-webassembly-part-2-from-molfile-to-inchi/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="Compiling InChI to WebAssembly Part 2: From Molfile to InChI">
  <meta property="og:description" content="A comprehensive tutorial with working demos.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-03-02T14:00:00+00:00">
    <meta property="article:modified_time" content="2020-03-02T14:00:00+00:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Compiling InChI to WebAssembly Part 2: From Molfile to InChI">
  <meta name="twitter:description" content="A comprehensive tutorial with working demos.">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Compiling InChI to WebAssembly Part 2: From Molfile to InChI",
    "headline": "Compiling InChI to WebAssembly Part 2: From Molfile to InChI",
    
    "abstract": "A comprehensive tutorial with working demos.",
    "inLanguage": "en-us",
    "url" : "http:\/\/localhost:1313\/articles\/2020\/03\/02\/compiling-inchi-to-webassembly-part-2-from-molfile-to-inchi\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    "copyrightYear": "2020",
    "dateCreated": "2020-03-02T14:00:00\u002b00:00",
    "datePublished": "2020-03-02T14:00:00\u002b00:00",
    
    "dateModified": "2020-03-02T14:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "1994"
  }]
  </script>


  
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Depth-First</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            

            </div>
        </label>
    </div>
</div>





  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Compiling InChI to WebAssembly Part 2: From Molfile to InChI
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2020-03-02T14:00:00&#43;00:00">March 2, 2020</time><span class="px-2 text-primary-500">&middot;</span><span>1994 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">10 mins</span>
  

  
  
</div>








    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
  <div class="place-self-center">
    
    
    <div class="text-2xl sm:text-lg">
</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
    

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          <p><a href="https://iupac.org/who-we-are/divisions/division-details/inchi/" target="_blank">InChI</a> is a software package that generates unique chemical identifiers. Although InChI&rsquo;s C source yields executables for many platforms, there are exceptions. For a long time, the Web browser was one of them. A few years ago, I showed how to compile <a href="https://metamolecular.com/inchi-js/" target="_blank">InChI to JavaScript</a>. That solution works, but recent developments, both in browsers and InChI itself, suggest a better approach is possible.</p>
<p>More recently, I described a procedure for <a href="/articles/2019/05/15/compiling-inchi-to-webassembly-part-1/">compiling the InChI main function to WebAssembly (aka Wasm)</a>. The result wasn&rsquo;t very useful because it just printed command line options and immediately exited. What&rsquo;s needed is a robust method for compiling useful InChI libraries to WebAssembly, which can then be exposed through thin JavaScript wrappers.</p>
<p>This article takes the next step by describing how to compile the InChI C source to Wasm, and then link the result through a concise, manually generated JavaScript wrapper. Only an LLVM toolchain is required. Unlike the previous article in this series, Emscripten is neither needed nor used. Beyond solving the specific problem of using InChI, what follows could be considered a blueprint for deploying any C code base to a Web browser.</p>


<h1 class="relative group">Quickstart 
    <div id="quickstart" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#quickstart" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Before describing the solution at a technical level, those who are only interested in testing the InChI-Wasm functionality can do so on the <a href="https://metamolecular.com/inchi-wasm" target="_blank">InChI-Wasm page</a>. GitHub hosts a <a href="https://github.com/rapodaca/inchi-wasm" target="_blank">source code repository</a>.</p>


<h1 class="relative group">Compilation 
    <div id="compilation" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#compilation" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Compilation to Wasm follows the <a href="/articles/2019/10/16/compiling-c-to-webassembly-and-running-it-without-emscripten/">previously-described system</a>. To recap:</p>
<ol>
<li>Install LLVM on your platform. On macOS, that probably means installing through Homebrew.</li>
<li>Activate LLVM, if necessary. macOS users will need to append the LLVM <code>bin</code> path to the <code>PATH</code> environment variable. Something like <code>export PATH=/usr/local/opt/llvm/bin:$PATH</code> should work.</li>
<li>Verify that LLVM is working with <code>llc --version</code>. The output should include <code>wasm32</code> and <code>wasm64</code>.</li>
<li>Clone, compile, and install <a href="https://github.com/CraneStation/wasi-libc" target="_blank">wasi-libc</a>.</li>
<li>Copy the file <a href="https://github.com/jedisct1/libclang_rt.builtins-wasm32.a" target="_blank">libclang_rt.builtins-wasm32.a</a> to your local LLVM <code>bin/wasi</code> directory.</li>
</ol>
<p>With these prerequisites out of the way, InChI-Wasm can be compiled. Clone <a href="https://github.com/rapodaca/inchi-wasm" target="_blank">the source</a>, change into the repo directory, then initialize the inchi submodule.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>git clone https://github.com/rapodaca/inchi-wasm
</span></span><span style="display:flex;"><span>cd inchi-wasm
</span></span><span style="display:flex;"><span>git submodule init
</span></span><span style="display:flex;"><span>git submodule update
</span></span></code></pre></div><p>Next, export the location of your <code>wasi-libc</code> installation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>export WASI_LIBC_HOME=/path/to/wasi-libc
</span></span></code></pre></div><p>Finally, compile InChI-Wasm with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>bin/build.sh
</span></span></code></pre></div><p>Running this script places the compiled <code>.wasm</code> file into the <code>build</code> directory.</p>


<h1 class="relative group">Technical Overview 
    <div id="technical-overview" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#technical-overview" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The main advantage of the approach described here over others is simplicity. A stock LLVM 9.0 installation and some libraries are all that&rsquo;s needed. In this respect, the method closely resembles that for compilation of a native binary. Recent updates to LLVM made this new approach feasible.</p>
<p>The structure of the <a href="https://github.com/rapodaca/inchi-wasm" target="_blank"><code>inchi-wasm</code></a> repository will likely reflect the structure of any project whose aim is to compile C source to Wasm:</p>
<ol>
<li><code>lib/wasi.js</code> A static JavaScript support file borrowed from <a href="https://github.com/wasmerio/wasmer-js" target="_blank">wasmer-js project</a>.</li>
<li><code>lib/molfile-to-inchi.js</code> A custom JavaScript bootstrap file that loads the <code>.wasm</code> file and defines a wrapper function.</li>
<li><code>src/molfile_to_inchi.c</code> A hand-coded wrapper function that converts a molfile string into an InChI string.</li>
<li><code>web/index.html</code> Invokes <code>molfile-to-inchi.js</code> and builds a test harness.</li>
<li><code>bin/build.sh</code> A build script that compiles and links <code>molfile_to_inchi.c</code> using LLVM.</li>
<li><code>inchi</code> git submodule. The unaltered InChI C source files <a href="https://github.com/metamolecular/inchi" target="_blank">hosted on GitHub</a>.</li>
</ol>


<h1 class="relative group"><code>src/molfile_to_inchi.c</code> 
    <div id="srcmolfile_to_inchic" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#srcmolfile_to_inchic" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>At the core of InChI-Wasm sits sits the function <code>molfile_to_inchi</code>, which is contained in the file <code>molfile_to_inchi.c</code>. Thanks to the addition of the <code>MakeINCHIFromMolfileText</code> function to the latest InChI revision, the requirements for the wrapper function were minimal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;time.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;inchi_api.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">size_t</span> <span style="color:#a6e22e">molfile_to_inchi</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>molfile, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>options, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>result)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    inchi_Output output;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> status <span style="color:#f92672">=</span> <span style="color:#a6e22e">MakeINCHIFromMolfileText</span>(molfile, options, <span style="color:#f92672">&amp;</span>output);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> status <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strcpy</span>(result, output.szInChI);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strcpy</span>(result, output.szMessage); <span style="color:#75715e">// this should work but doesn&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FreeINCHI</span>(<span style="color:#f92672">&amp;</span>output);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// see:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// https://stackoverflow.com/questions/31476632/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// https://stackoverflow.com/a/617606/54426
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">clock_t</span> <span style="color:#a6e22e">__wrap_clock</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>molfile_to_inchi</code> function accepts three parameters representing buffers for the input molfile, InChI options, and the InChI result. Invocation of the <code>MakeINCHIFromMolfileText</code> is followed by <code>strcpy</code> to set the output buffer with the result. After freeing a temporary data structure, an integer status code is returned.</p>
<p>The InChI documentation implies that <code>MakeINCHIFromMolfileText</code> places error messages into the <code>szMessage</code> field of the <code>inchi_Output</code> struct. This technique was previously used to compile InChI to Javascript. However, I have not been able to get such error reporting to work in the current iteration.</p>
<p>I&rsquo;ll have more to say about the second function, <code>__wrap_clock</code>, later.</p>


<h1 class="relative group"><code>lib/molfile-to-inchi.js</code> 
    <div id="libmolfile-to-inchijs" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#libmolfile-to-inchijs" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The C function has a counterpart written in JavaScript and hosted at <code>lib/molfile-to-inchi.js</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">WASI</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./wasi.esm.js&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmPath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;../build/molfile_to_inchi.wasm&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">memory</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Memory</span>({ <span style="color:#a6e22e">initial</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">wasmPath</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bytes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">arrayBuffer</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasi</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WASI</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">instance</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiate</span>(<span style="color:#a6e22e">bytes</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">env</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">memory</span> }, <span style="color:#a6e22e">wasi_snapshot_preview1</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">wasi</span>.<span style="color:#a6e22e">wasiImport</span>
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pMolfile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">1024</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pOptions</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">1024</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pOutput</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">20480</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  window.<span style="color:#a6e22e">molfileToInChI</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">molfile</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">inputView</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">encoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextEncoder</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">inputView</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">molfile</span>), <span style="color:#a6e22e">pMolfile</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">molfile_to_inchi</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pMolfile</span>, <span style="color:#a6e22e">pOptions</span>, <span style="color:#a6e22e">pOutput</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">outputView</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">decoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextDecoder</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">output</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">decode</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">outputView</span>.<span style="color:#a6e22e">subarray</span>(<span style="color:#a6e22e">pOutput</span>, <span style="color:#a6e22e">outputView</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">pOutput</span>))
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">result</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> Error(<span style="color:#e6db74">&#34;inchi error: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">output</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">output</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  window.<span style="color:#a6e22e">dispatchEvent</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Event</span>(<span style="color:#e6db74">&#39;InChIReady&#39;</span>));
</span></span><span style="display:flex;"><span>})();
</span></span></code></pre></div><p>The file begins by importing <code>WASI</code> from the <code>wasi.esm.js</code> file. Doing so enables the instantiation of an object with the <code>wasiImport</code> property. This property is used to create the WebAssembly <code>instance</code>.</p>
<p>The main block uses the asynchronous IIFE pattern <a href="/articles/2019/10/16/compiling-c-to-webassembly-and-running-it-without-emscripten/">discussed previously</a>. Briefly, async/await functionality must be wrapped in a function using the <code>async</code> keyword. The asynchronous IIFE pattern is a convenient way to take advantage of async/await operations.</p>
<p>Three memory allocations are made using the Wasm instance&rsquo;s <code>malloc</code> function. Each call returns a pointer into <a href="https://webassembly.org/docs/semantics/#linear-memory" target="_blank">linear memory</a>. The pointers are passed into the instance&rsquo;s <code>molfile_to_inchi</code> function. The result is an integer response code that can be used for reporting.</p>
<p>If no error codes are returned, the string representation of the buffer holding the InChI is returned.</p>
<p>The penultimate line dispatches a custom <code>InChIReady</code> event signaling that the global <code>molfileToInChI</code> function can be used. Attempts to access the function before the event is fired will result in an error.</p>


<h1 class="relative group">bin/build.sh 
    <div id="binbuildsh" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#binbuildsh" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The script located at <code>bin/build.sh</code> orchestrates the compilation of <code>molfile_from_inchi.c</code> and the InChI source files. Two checks take place before compilation. First, the build script requires that the environment variable <code>WASI_LIBC_HOME</code> be set, or an error will result. Second, the operating system is checked. If macOS is detected, the InChI-specific flag <code>__APPLE__</code>, is set as <a href="/2019/05/15/compiling-inchi-to-webassembly-part-1/">previously described</a>. After making these checks, a build directory is created if necessary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$WASI_LIBC_HOME<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Reading libc from </span>$WASI_LIBC_HOME<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Set the libc location with &#39;export WASI_LIBC_HOME=path/to/wasi-libc&#39;.&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$OSTYPE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span>~ ^darwin <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  PLATFORM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-D__APPLE__&#34;</span>
</span></span><span style="display:flex;"><span>  PATH<span style="color:#f92672">=</span>/usr/local/opt/llvm/bin:$PATH
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  PLATFORM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clang <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --target<span style="color:#f92672">=</span>wasm32-unknown-wasi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --sysroot <span style="color:#e6db74">${</span>WASI_LIBC_HOME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Oz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-import-memory <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-wrap,clock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-export,malloc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-export,molfile_to_inchi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Wl,-no-entry <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -DTARGET_API_LIB <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">${</span>PLATFORM<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Iinchi/INCHI_BASE/src <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  inchi/INCHI_BASE/src/*.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  inchi/INCHI_API/libinchi/src/*.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  src/molfile_to_inchi.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -o build/molfile_to_inchi.wasm
</span></span></code></pre></div><p>With all checks performed and a <code>build</code> directory in place, the build script invokes <code>clang</code>. Options are explained as follows:</p>
<ul>
<li><code>--target=wasm32-unknown-wasi</code>. Directs compilation using the <a href="https://hacks.mozilla.org/2019/03/standardizing-wasi-a-webassembly-system-interface/" target="_blank">WebAssembly System Interface</a>.</li>
<li><code>--sysroot ${WASI_LIBC_HOME}</code>. Replaces the standard library with wasi-libc.</li>
<li><code>-Oz</code>. Aggressive optimization.</li>
<li><code>-v</code> Verbose output.</li>
<li><code>-Wl,-import-memory</code>. Require that the Wasm instance be supplied with <code>WebAssembly.Memory</code> instance.</li>
<li><code>-Wl,-wrap,clock</code>. Wraps the <code>clock</code> standard library function, for reasons described below. Note the single dash (<code>-</code>).</li>
<li><code>-Wl,-export,malloc</code>. Make <code>malloc</code> available to the Wasm instance.</li>
<li><code>-Wl,-export,molfile_to_inchi</code>. Make <code>molfile_to_inchi</code> available to the Wasm instance.</li>
<li><code>-Wl,-no-entry</code>. Don&rsquo;t check for a <code>main</code> function.</li>
<li><code>-DTARGET_API_LIB</code>. One of four settings required by InChI.</li>
<li><code>${PLATFORM}</code>. Optionally includes the <code>-D__APPLE__</code> InChI flag.</li>
<li><code>-Iinchi/INCHI_BASE/src</code>. Path to search for InChI headers.</li>
<li><code>inchi/INCHI_BASE/src/*.c</code>. One path to InChI source files.</li>
<li><code>inchi/INCHI_API/libinchi/src/*.c</code>. Another path to InChI source files.</li>
<li><code>src/molfile_to_inchi.c</code>. Path to the file containing the wrapper function.</li>
<li><code>-o build/molfile_to_inchi.wasm</code>. The path to the compiled wasm file.</li>
</ul>
<p>Deleting the <code>-Wl,-wrap,clock</code> option will result in a JavaScript runtime error. Depending on your browser, you may see:</p>
<ul>
<li>Safari. <code>TypeError: i64 not allowed as return type or argument to an imported function</code></li>
<li>Firefox. <code>TypeError: cannot pass i64 to or from JS</code></li>
<li>Chrome. <code>Uncaught TypeError: wasm function signature contains illegal type</code></li>
</ul>
<p>These errors <a href="https://github.com/unoplatform/Uno.Wasm.Bootstrap/issues/128" target="_blank">appear</a> to trace back to the current <a href="https://webassembly.org/docs/c-and-c&#43;&#43;/" target="_blank">lack of support for 64-bit types</a> in browser-based Wasm implementations. The situation will eventually be corrected, but for now calls dealing with 64-bit types such as <code>clock</code> and <code>times</code> will require workarounds.</p>
<p>The <code>wrap</code> option lets us override the <code>clock</code> function - without touching the InChI code base. The tradeoff is that all of the code relying on time will be rendered inoperable. This doesn&rsquo;t affect InChI, at least not the way it&rsquo;s accessed in this article. However, other applications of InChI or other code bases may require more or less work to get past the 64-bit issue on browsers.</p>


<h1 class="relative group">index.html 
    <div id="indexhtml" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#indexhtml" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The HTML file located at <code>web/index.html</code> invokes the <code>molfile-to-inchi.js</code> script and sets up the test harness. Note the presence of the <code>type=&quot;module&quot;</code> attribute on the <code>&lt;script&gt;</code> tag, which is required.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;InChI WASM Test&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../lib/molfile-to-inchi.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">style</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">label</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-size</span>: <span style="color:#ae81ff">120</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-weight</span>: <span style="color:#66d9ef">bold</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">padding-bottom</span>: <span style="color:#ae81ff">1</span><span style="color:#66d9ef">em</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      #molfile {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">width</span>: <span style="color:#ae81ff">100</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">height</span>: <span style="color:#ae81ff">400</span><span style="color:#66d9ef">px</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-size</span>: <span style="color:#ae81ff">120</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-family</span>: <span style="color:#66d9ef">monospace</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">margin-bottom</span>: <span style="color:#ae81ff">1</span><span style="color:#66d9ef">em</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      #inchi {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">width</span>: <span style="color:#ae81ff">100</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">height</span>: <span style="color:#ae81ff">1.5</span><span style="color:#66d9ef">em</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-size</span>: <span style="color:#ae81ff">120</span><span style="color:#66d9ef">%</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">font-family</span>: <span style="color:#66d9ef">monospace</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">style</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;molfile&#34;</span>&gt;Molfile:&lt;/<span style="color:#f92672">label</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">textarea</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;molfile&#34;</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   CWRITER02282009502D
</span></span><span style="display:flex;"><span>Created with ChemWriter - https://chemwriter.com
</span></span><span style="display:flex;"><span>  6  6  0  0  0  0  0  0  0  0999 V2000
</span></span><span style="display:flex;"><span>   75.8435  -39.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   84.5038  -44.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   93.1640  -39.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   93.1640  -29.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   84.5038  -24.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>   75.8435  -29.8212    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
</span></span><span style="display:flex;"><span>  1  2  2  0  0  0  0
</span></span><span style="display:flex;"><span>  2  3  1  0  0  0  0
</span></span><span style="display:flex;"><span>  3  4  2  0  0  0  0
</span></span><span style="display:flex;"><span>  4  5  1  0  0  0  0
</span></span><span style="display:flex;"><span>  5  6  2  0  0  0  0
</span></span><span style="display:flex;"><span>  6  1  1  0  0  0  0
</span></span><span style="display:flex;"><span>M  END&lt;/<span style="color:#f92672">textarea</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inchi&#34;</span>&gt;InChI:&lt;/<span style="color:#f92672">label</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">textarea</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inchi&#34;</span>&gt;&lt;/<span style="color:#f92672">textarea</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">update</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">molfile</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">molfileToInChI</span>(<span style="color:#a6e22e">molfile</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>          document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#inchi&#39;</span>).<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ERROR&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#inchi&#39;</span>).<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;InChIReady&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">molfile</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#molfile&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">molfile</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">molfile</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;input&#39;</span>, (<span style="color:#a6e22e">e</span>) =&gt; {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">molfile</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>After setting up some styles and script invocations in the <code>&lt;head&gt;</code> element, the HTML file defines two text areas - one for molfile input and the other for InChI output. a <code>&lt;script&gt;</code> coordinates the interaction between the two, invoking the <code>molfileToInChI</code> function as needed.</p>


<h1 class="relative group">wasi.js 
    <div id="wasijs" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#wasijs" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The file at <code>lib/wasi.esm.js</code> was copied verbatim from the  <a href="https://github.com/wasmerio/wasmer-js" target="_blank">wasmer-js project</a>. This file never needs to be changed and so can be used in any Wasm build. Projects not using the Standard C library do not need this file, but should make adjustments to the instantiation of the Wasm instance.</p>


<h1 class="relative group">inchi submodule 
    <div id="inchi-submodule" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#inchi-submodule" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The InChI source code is installed as a <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules" target="_blank">Git submodule</a> from <a href="https://github.com/metamolecular/inchi" target="_blank">an unofficial InChI GitHub repository</a>.</p>
<p>This method ensures that InChI-Wasm can continue to be compiled as updates to the InChI C source package are made.</p>


<h1 class="relative group">Conclusion 
    <div id="conclusion" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conclusion" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>This article describes the first successful compilation of a molfile to InChI function from C to WebAssembly. The underlying library is a non-trivial code base written in C, none of whose files files were modified. This was accomplished using a stock LLVM installation and some support libraries. Emscripten was not used. Supporting files used in this project are compact and follow up-to-date practices.</p>
<p>The same approach outlined here could be applied to any cheminformatics or computational chemistry package written in C or C++. The recent arrival of the LLVM-based <a href="https://github.com/flang-compiler/f18" target="_blank">F18 compiler</a> may even enable the compilation of older computational chemistry packages written in Fortran to WebAssembly.</p>

          
          
          
        </div>
        
        

        
        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2020-03-02-compiling-inchi-to-webassembly-part-2-from-molfile-to-inchi.md"
        var oid_likes = "likes_posts\/2020-03-02-compiling-inchi-to-webassembly-part-2-from-molfile-to-inchi.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/articles/2020/02/24/rethinking-the-chemical-reaction-as-a-graph-imaginary-transition-structures-and-beyond/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Rethinking the Chemical Reaction as a Graph: Imaginary Transition Structures and Beyond</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-02-24T14:00:00&#43;00:00">February 24, 2020</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/articles/2020/03/09/a-brief-introduction-to-graph-convolutional-networks/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >A Brief Introduction to Graph Convolutional Networks</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-03-09T14:00:00&#43;00:00">March 9, 2020</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="http://localhost:1313/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
