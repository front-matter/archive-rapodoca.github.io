<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Compiling Rust to WebAssembly: A Simple Example | Depth-First</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="A short, no-frills guide from blank project to running code.">
    <meta name="generator" content="Hugo 0.139.4">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/articles/2020-06-29-compiling-rust-to-webassembly-a-simple-example/">
    

    <meta property="og:url" content="http://localhost:1313/articles/2020-06-29-compiling-rust-to-webassembly-a-simple-example/">
  <meta property="og:site_name" content="Depth-First">
  <meta property="og:title" content="Compiling Rust to WebAssembly: A Simple Example">
  <meta property="og:description" content="A short, no-frills guide from blank project to running code.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="articles">
    <meta property="article:published_time" content="2020-06-29T17:00:00+00:00">
    <meta property="article:modified_time" content="2020-06-29T17:00:00+00:00">

  <meta itemprop="name" content="Compiling Rust to WebAssembly: A Simple Example">
  <meta itemprop="description" content="A short, no-frills guide from blank project to running code.">
  <meta itemprop="datePublished" content="2020-06-29T17:00:00+00:00">
  <meta itemprop="dateModified" content="2020-06-29T17:00:00+00:00">
  <meta itemprop="wordCount" content="655">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Compiling Rust to WebAssembly: A Simple Example">
  <meta name="twitter:description" content="A short, no-frills guide from blank project to running code.">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Depth-First
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Articles
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Compiling Rust to WebAssembly: A Simple Example</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-06-29T17:00:00Z">June 29, 2020</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p><a href="https://www.rust-lang.org">Rust</a> and <a href="https://webassembly.org">WebAssembly</a> (Wasm) are often discussed together. The former is a typesafe systems programming language with modern tooling and many high-level features. The latter is a portable, secure execution environment that runs inside and outside the browser. The combination promises many years of progress and utility.</p>
<p>Unfortunately, the path to starting with Rust and WebAssembly isn&rsquo;t as simple as it could be. A number of sophisticated technologies have popped up around the Rust/Wasm duo. This is great for experienced users but can overcomplicate getting started. This article aims to fill the gap with a no-frills introduction to building Rust code targeting the browser.</p>
<h1 id="overview">Overview</h1>
<p>The goal of this project is to compile to Wasm a Rust function that adds one to a value passed in and returns the result. These are the steps:</p>
<ol>
<li>Create a vanilla Rust project template.</li>
<li>Update the project&rsquo;s manifest file.</li>
<li>Write a Rust function.</li>
<li>Compile to optimized Wasm.</li>
<li>Deploy the Wasm through a simple Web page.</li>
</ol>
<h1 id="prerequisites">Prerequisites</h1>
<p>Begin by installing the Rust language tools with <a href="https://rustup.rs">rustup</a> if you haven&rsquo;t already. Next, install the Wasm toolchain:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rustup target add wasm32-unknown-unknown
</span></span></code></pre></div><p>Install <a href="https://github.com/alexcrichton/wasm-gc">wasm-gc</a>, which will be used to compress the <code>*.wasm</code> file output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo install wasm-gc
</span></span></code></pre></div><p>Finally, create a test project and change into it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo new hello --lib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cd hello
</span></span></code></pre></div><h1 id="update-cargotoml">Update Cargo.toml</h1>
<p>The file <a href="http://web.mit.edu/rust-lang_v1.25/arch/amd64_ubuntu1404/share/doc/rust/html/cargo/reference/manifest.html"><code>Cargo.toml</code></a>  (aka &ldquo;manifest&rdquo;) contains the project&rsquo;s configuration. Leave everything, but append a new block called <code>[lib]</code>. The result should look something this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># Cargo.toml</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">package</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">version</span> = <span style="color:#e6db74">&#34;0.1.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">authors</span> = [<span style="color:#e6db74">&#34;Richard Apodaca &lt;rich.apodaca@gmail.com&gt;&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">edition</span> = <span style="color:#e6db74">&#34;2018&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">dependencies</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># new material</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">lib</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">crate-type</span> = [<span style="color:#e6db74">&#34;cdylib&#34;</span>]
</span></span></code></pre></div><h1 id="bring-on-the-code">Bring on the Code!</h1>
<p>Rust code lives in the <code>src</code> directory. Your new project contains the default file <code>src/lib.rs</code>. Replace its contents with the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// src/lib.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_one</span>(x: <span style="color:#66d9ef">i32</span>) -&gt; <span style="color:#66d9ef">i32</span> {
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function accepts a 32-bit integer value, returning the result as 32-bit integer.</p>
<h1 id="compile-to-wasm">Compile to Wasm</h1>
<p>Compile the project to Wasm:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>cargo build --target wasm32-unknown-unknown --release
</span></span></code></pre></div><p>The result is a rather large Wasm file in <code>target/wasm32-unknown-unknown/release/</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>ls -la target/wasm32-unknown-unknown/release/hello.wasm
</span></span><span style="display:flex;"><span>-rwxr-xr-x  2 rich  staff  1566966 Jun 28 20:05 target/wasm32-unknown-unknown/release/hello.wasm
</span></span></code></pre></div><h1 id="shrink-the-wasm-output">Shrink the Wasm Output</h1>
<p>The Wasm initially produced by the compiler contains a lot of unnecessary material. How much? To find out, use <code>wasm-gc</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>wasm-gc target/wasm32-unknown-unknown/release/hello.wasm
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>ls -la target/wasm32-unknown-unknown/release/hello.wasm
</span></span><span style="display:flex;"><span>-rwxr-xr-x  2 rich  staff  209 Jun 28 20:05 target/wasm32-unknown-unknown/release/hello.wasm
</span></span></code></pre></div><p><code>wasm-gc</code> cut the output to the bone, leaving a 209 byte file.</p>
<h1 id="javascript-and-html">JavaScript and HTML</h1>
<p>One of the simpler (but not only) ways to execute the Wasm output is with a browser running a little JavaScript. Add the following to a new file called <code>index.html</code> a the project root:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;title&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#39;target/wasm32-unknown-unknown/release/hello.wasm&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">bytes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">arrayBuffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">instance</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiate</span>(<span style="color:#a6e22e">bytes</span>, { });
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;The answer is: &#39;</span>, <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">add_one</span>(<span style="color:#ae81ff">13</span>));
</span></span><span style="display:flex;"><span>      })();
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><h1 id="run-the-example">Run the Example</h1>
<p>You won&rsquo;t be able to load the HTML file in your browser directly due to security restrictions. Instead, you&rsquo;ll need to run a local server. A simple way to do that takes advantage of Python&rsquo;s built-in server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>python -m SimpleHTTPServer
</span></span></code></pre></div><p>Browsing to <a href="http://localhost:8000">localhost:8000</a> should yield a blank page. Open a developer console to see the result.</p>
<!-- raw HTML omitted -->
<h1 id="future-directions">Future Directions</h1>
<p>With basic project setup out of the way, it&rsquo;s possible to explore many avenues. The most obvious may be to expand the range of input/output types. Wasm only understands four numerical types: i32; i64; f32; and f64. How can the project be extended to accept or output more complex types such as strings? <a href="https://depth-first.com/articles/2020/01/13/first-steps-in-webassembly-hello-world/">This post</a> may be a good starting point. But even keeping to the four native Wasm types, a number of complex programs can be constructed for benchmarking and other purposes. At the very least, studying this simple example will help clarify what the more advanced tooling such as <a href="https://github.com/rustwasm/wasm-bindgen">wasm-bindgen</a> is doing and why it may be useful.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  Depth-First 2024 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
